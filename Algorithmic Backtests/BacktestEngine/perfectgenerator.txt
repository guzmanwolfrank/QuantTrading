

# ======================================================================
# 5. HTML REPORT GENERATOR (Placeholder - use your existing full implementation)
# ======================================================================




class HTMLReportGenerator:
    """
    Modern, visually stunning dashboard with Chart.js + Matplotlib
    NO Plotly - using Chart.js for perfect dark theme control
    Matplotlib for static equity and comparison charts
    """

    @staticmethod
    def _generate_ai_analysis(metrics, trades_df, initial_balance, strategy_name, pair, timeframe, 
                              start_date, end_date, leverage, sl_pips, tp_pips, risk_pct):
        """
        Generate comprehensive AI-powered analysis of strategy performance
        Two-column layout: Verbal analysis on left, Statistical metrics on right
        Includes full QuantStats-style metrics suite, backtest criteria analysis, and market conditions
        """
        if trades_df.empty:
            return "<p style='color: #888888;'>No trades available for analysis.</p>"

        # Calculate key metrics
        total_return = metrics.get('total_return_pct', 0)
        win_rate = metrics.get('win_rate', 0)
        profit_factor = metrics.get('profit_factor', 0)
        sharpe = metrics.get('sharpe_ratio', 0)
        sortino = metrics.get('sortino_ratio', 0)
        max_dd = metrics.get('max_drawdown_pct', 0)
        total_trades = len(trades_df)
        avg_win = metrics.get('avg_win', 0)
        avg_loss = metrics.get('avg_loss', 0)
        final_balance = metrics.get('final_balance', initial_balance)

        # Calculate additional statistics
        import numpy as np
        from scipy import stats as scipy_stats

        returns = trades_df['monetary_pnl'].values
        returns_pct = (returns / initial_balance) * 100

        # Basic statistics
        mean_return = np.mean(returns_pct)
        std_dev = np.std(returns_pct)
        variance = np.var(returns_pct)
        skewness = float(scipy_stats.skew(returns_pct)) if len(returns_pct) > 2 else 0
        kurtosis = float(scipy_stats.kurtosis(returns_pct)) if len(returns_pct) > 2 else 0

        # Winning vs losing statistics
        win_trades = trades_df[trades_df['monetary_pnl'] > 0]
        loss_trades = trades_df[trades_df['monetary_pnl'] <= 0]

        wins_count = len(win_trades)
        losses_count = len(loss_trades)

        # QuantStats metrics
        best_return = returns_pct.max() if len(returns_pct) > 0 else 0
        worst_return = returns_pct.min() if len(returns_pct) > 0 else 0

        # CAGR (Compound Annual Growth Rate)
        if not trades_df.empty:
            days = (trades_df['exit_time'].iloc[-1] - trades_df['exit_time'].iloc[0]).days
            years = days / 365.25 if days > 0 else 1
            cagr = (((final_balance / initial_balance) ** (1 / years)) - 1) * 100 if years > 0 else 0
        else:
            cagr = 0
            years = 1

        # Calmar Ratio (CAGR / Max Drawdown)
        calmar = (cagr / abs(max_dd)) if max_dd != 0 else 0

        # Value at Risk (VaR) - 95% confidence
        var_95 = np.percentile(returns_pct, 5) if len(returns_pct) > 0 else 0

        # Conditional Value at Risk (CVaR) - Expected Shortfall
        cvar_95 = returns_pct[returns_pct <= var_95].mean() if len(returns_pct[returns_pct <= var_95]) > 0 else 0

        # Payoff Ratio (Avg Win / Avg Loss)
        payoff_ratio = abs(avg_win / avg_loss) if avg_loss != 0 else 0

        # Gain to Pain Ratio
        positive_returns = returns[returns > 0].sum()
        negative_returns = abs(returns[returns < 0].sum())
        gain_to_pain = positive_returns / negative_returns if negative_returns != 0 else 0

        # Recovery Factor (Total Return / Max Drawdown)
        recovery_factor = abs(total_return / max_dd) if max_dd != 0 else 0

        # Ulcer Index (measure of downside volatility)
        if not trades_df.empty:
            equity_curve = trades_df['balance'].values
            running_max = np.maximum.accumulate(equity_curve)
            drawdown_pct = ((equity_curve - running_max) / running_max) * 100
            ulcer_index = np.sqrt(np.mean(drawdown_pct ** 2))
        else:
            ulcer_index = 0

        # Risk of Ruin (simplified Kelly Criterion based)
        win_prob = win_rate / 100
        loss_prob = 1 - win_prob
        if payoff_ratio > 0 and win_prob > 0:
            kelly_pct = (win_prob * payoff_ratio - loss_prob) / payoff_ratio
            risk_of_ruin = ((1 - kelly_pct) / (1 + kelly_pct)) ** 100 if kelly_pct > 0 else 1.0
        else:
            kelly_pct = 0
            risk_of_ruin = 1.0

        # Outlier analysis
        q1 = np.percentile(returns_pct, 25)
        q3 = np.percentile(returns_pct, 75)
        iqr = q3 - q1
        outlier_threshold = 1.5 * iqr
        outliers = returns_pct[(returns_pct < q1 - outlier_threshold) | (returns_pct > q3 + outlier_threshold)]
        outlier_win_ratio = len(outliers[outliers > 0]) / len(outliers) if len(outliers) > 0 else 0
        outlier_loss_ratio = len(outliers[outliers < 0]) / len(outliers) if len(outliers) > 0 else 0

        # Consecutive wins/losses
        trades_df_copy = trades_df.copy()
        trades_df_copy['is_win'] = (trades_df_copy['monetary_pnl'] > 0).astype(int)

        # Calculate trade durations
        trades_df_copy['duration_hours'] = (trades_df_copy['exit_time'] - trades_df_copy['entry_time']).dt.total_seconds() / 3600
        avg_trade_duration = trades_df_copy['duration_hours'].mean() if len(trades_df_copy) > 0 else 0
        max_trade_duration = trades_df_copy['duration_hours'].max() if len(trades_df_copy) > 0 else 0
        min_trade_duration = trades_df_copy['duration_hours'].min() if len(trades_df_copy) > 0 else 0

        # Calculate average winning and losing trade durations
        avg_win_duration = trades_df_copy[trades_df_copy['monetary_pnl'] > 0]['duration_hours'].mean() if len(win_trades) > 0 else 0
        avg_loss_duration = trades_df_copy[trades_df_copy['monetary_pnl'] <= 0]['duration_hours'].mean() if len(loss_trades) > 0 else 0

        # Calculate streaks
        streak_changes = trades_df_copy['is_win'].diff().fillna(0) != 0
        streak_ids = streak_changes.cumsum()
        streaks = trades_df_copy.groupby([streak_ids, 'is_win']).size()

        max_win_streak = int(streaks[streaks.index.get_level_values(1) == 1].max()) if any(streaks.index.get_level_values(1) == 1) else 0
        max_loss_streak = int(streaks[streaks.index.get_level_values(1) == 0].max()) if any(streaks.index.get_level_values(1) == 0) else 0

        # Expectancy (Expected value per trade)
        expectancy = (win_rate / 100 * avg_win) + ((100 - win_rate) / 100 * avg_loss)

        # Tail Ratio (95th percentile / 5th percentile)
        p95 = np.percentile(returns_pct, 95) if len(returns_pct) > 0 else 0
        p5 = np.percentile(returns_pct, 5) if len(returns_pct) > 0 else 0
        tail_ratio = abs(p95 / p5) if p5 != 0 else 0

        # Common Sense Ratio (Profit Factor - 1)
        common_sense_ratio = profit_factor - 1

        # Monthly performance variability
        trades_df_copy['month'] = trades_df_copy['exit_time'].dt.to_period('M')
        if len(trades_df_copy['month'].unique()) > 1:
            monthly_returns = trades_df_copy.groupby('month')['monetary_pnl'].sum()
            monthly_std = monthly_returns.std()
            monthly_mean = monthly_returns.mean()
            positive_months = len(monthly_returns[monthly_returns > 0])
            total_months = len(monthly_returns)
        else:
            monthly_std = 0
            monthly_mean = 0
            positive_months = 0
            total_months = 1

        # Calculate buy & hold comparison (using actual underlying performance)
        # Simulate buy & hold: same leverage, held entire period
        if not trades_df.empty:
            # Get first and last prices
            first_price = trades_df['entry_price'].iloc[0]
            last_price = trades_df['exit_price'].iloc[-1]

            # Calculate price change
            price_change_pct = ((last_price - first_price) / first_price) * 100

            # Apply leverage to buy & hold
            buy_hold_return = price_change_pct * leverage

            # Calculate alpha (outperformance)
            strategy_outperformance = total_return - buy_hold_return
        else:
            buy_hold_return = 0
            strategy_outperformance = 0

        # Performance assessment
        if total_return > 20:
            performance = "exceptional"
            perf_color = "#00ff88"
        elif total_return > 10:
            performance = "strong"
            perf_color = "#00ff88"
        elif total_return > 0:
            performance = "positive"
            perf_color = "#00d4ff"
        else:
            performance = "concerning"
            perf_color = "#ff3366"

        # Risk-reward ratio
        risk_reward = payoff_ratio

        # Extract underlying asset name
        underlying_asset = f"{pair} ({timeframe} timeframe)"

        # Get current market conditions (Note: These would need to be passed in or fetched via API in production)
        # For now, we'll use placeholder text that explains what should be monitored
        from datetime import datetime
        current_date = datetime.now().strftime("%B %Y")

        analysis_html = f"""
        <div style="background: linear-gradient(135deg, #161616 0%, #1a1a1a 100%); 
                    border-radius: 16px; 
                    padding: 40px; 
                    border: 1px solid #222222; 
                    margin-bottom: 60px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
            <h3 style="font-size: 18px; 
                       font-weight: 700; 
                       color: {perf_color}; 
                       margin-bottom: 32px; 
                       text-transform: uppercase; 
                       letter-spacing: 1.5px;
                       display: flex;
                       align-items: center;
                       gap: 12px;">
                <span style="width: 4px; height: 24px; background: {perf_color}; border-radius: 2px;"></span>
                AI PERFORMANCE ANALYSIS
            </h3>

            <!-- Two Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">

                <!-- LEFT COLUMN: Verbal Analysis -->
                <div style="color: #e0e0e0; font-size: 14px; line-height: 1.9; font-weight: 300;">

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
                        Backtest Criteria & Underlying Asset
                    </h4>
                    <p style="margin-bottom: 20px;">
                        <strong style="color: #00d4ff; font-size: 16px;">UNDERLYING: {underlying_asset}</strong><br><br>
                        This backtest evaluated the <strong style="color: #ffffff;">{strategy_name}</strong> strategy 
                        on <strong style="color: #ffffff;">{pair}</strong> using <strong style="color: #ffffff;">{timeframe}</strong> candles 
                        from <strong style="color: #ffffff;">{start_date}</strong> to <strong style="color: #ffffff;">{end_date}</strong> 
                        ({years:.1f} years of data). The strategy operated with the following parameters:
                        <strong style="color: #ffffff;">{leverage}x leverage</strong>, 
                        <strong style="color: #ffffff;">{sl_pips}-pip stop loss</strong>, 
                        <strong style="color: #ffffff;">{tp_pips}-pip take profit</strong>, 
                        and <strong style="color: #ffffff;">{risk_pct}% risk per trade</strong>. 
                        Starting capital: <strong style="color: #ffffff;">${initial_balance:,.0f}</strong>.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
                        Strategy vs Underlying Performance
                    </h4>
                    <p style="margin-bottom: 20px;">
                        <strong style="color: #ffffff;">Active Strategy Return:</strong> <strong style="color: {perf_color};">{total_return:.2f}%</strong> 
                        (CAGR: <strong style="color: {perf_color};">{cagr:.2f}%</strong>)<br>
                        <strong style="color: #ffffff;">Buy & Hold Return:</strong> <strong style="color: {'#00ff88' if buy_hold_return > 0 else '#ff3366'};">{buy_hold_return:.2f}%</strong> 
                        ({leverage}x leveraged)<br>
                        <strong style="color: #ffffff;">Alpha Generated:</strong> <strong style="color: {'#00ff88' if strategy_outperformance > 0 else '#ff3366'};">{strategy_outperformance:+.2f}%</strong><br><br>

                        {'üéØ The active strategy <strong style="color: #00ff88;">OUTPERFORMED</strong> the underlying asset by <strong style="color: #00ff88;">{abs(strategy_outperformance):.2f}%</strong>. ' if strategy_outperformance > 0 else '‚ö†Ô∏è The active strategy <strong style="color: #ff3366;">UNDERPERFORMED</strong> the underlying by <strong style="color: #ff3366;">{abs(strategy_outperformance):.2f}%</strong>. '}
                        {f'This demonstrates clear <strong>alpha generation</strong>, meaning the strategy successfully identified profitable entry and exit points beyond simple directional exposure. The {total_trades} trades executed captured market inefficiencies that passive holding could not exploit.' if strategy_outperformance > 5 else f'While the strategy generated positive returns, it slightly lagged a simple buy & hold approach. This suggests the {pair} market trended favorably during the test period, and transaction costs may have eroded some gains. Consider optimizing entry criteria or holding periods.' if strategy_outperformance > -5 and total_return > 0 else f'The strategy underperformed passive holding, indicating that market conditions favored trend-following over the active approach. The {total_trades} trades may have been mistimed relative to the underlying price action.' if total_return > 0 else 'Both the strategy and passive approach would have resulted in losses, suggesting this was a challenging period for the market.'}
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
                        Performance Overview
                    </h4>
                    <p style="margin-bottom: 20px;">
                        The strategy demonstrates <strong style="color: {perf_color};">{performance}</strong> performance, 
                        growing the account from <strong style="color: #ffffff;">${initial_balance:,.0f}</strong> to 
                        <strong style="color: {perf_color};">${final_balance:,.0f}</strong> 
                        (a <strong style="color: {perf_color};">{((final_balance/initial_balance - 1) * 100):.1f}%</strong> gain). 
                        The Calmar ratio of <strong style="color: #ffffff;">{calmar:.2f}</strong> 
                        {'indicates excellent risk-adjusted performance (>3.0 is exceptional)' if calmar > 3 else 'shows good return relative to drawdown (>1.0 is favorable)' if calmar > 1 else 'suggests room for improvement in return vs drawdown'}, 
                        balancing profitability against maximum portfolio decline.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Win Rate & Consistency
                    </h4>
                    <p style="margin-bottom: 20px;">
                        With a win rate of <strong style="color: #ffffff;">{win_rate:.1f}%</strong> 
                        ({wins_count} wins vs {losses_count} losses), the strategy {'demonstrates strong directional accuracy' if win_rate > 55 else 'maintains adequate win frequency' if win_rate > 45 else 'requires larger wins to offset the lower hit rate'}. 
                        The maximum winning streak of <strong style="color: #ffffff;">{max_win_streak}</strong> trades 
                        versus the maximum losing streak of <strong style="color: #ffffff;">{max_loss_streak}</strong> trades 
                        indicates {'healthy momentum capture with controlled drawdown periods' if max_win_streak > max_loss_streak * 1.5 else 'balanced performance with typical market variability' if max_win_streak >= max_loss_streak else 'vulnerability to extended losing periods that should be monitored'}.
                        Monthly win rate: <strong style="color: #ffffff;">{(positive_months/total_months*100):.1f}%</strong> ({positive_months}/{total_months} profitable months).
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Risk Management
                    </h4>
                    <p style="margin-bottom: 20px;">
                        The strategy exhibits a maximum drawdown of <strong style="color: #ffffff;">{max_dd:.2f}%</strong>, 
                        which falls into the {'conservative' if max_dd < 10 else 'moderate' if max_dd < 20 else 'aggressive'} risk category. 
                        The Ulcer Index of <strong style="color: #ffffff;">{ulcer_index:.2f}</strong> quantifies downside volatility, 
                        while the Recovery Factor of <strong style="color: #ffffff;">{recovery_factor:.2f}</strong> 
                        {'demonstrates excellent recovery capability' if recovery_factor > 3 else 'shows adequate recovery from drawdowns' if recovery_factor > 2 else 'suggests extended recovery periods'}.
                        {'This low drawdown indicates excellent capital preservation and risk control.' if max_dd < 10 else 'This moderate drawdown suggests balanced risk-taking appropriate for most trading accounts.' if max_dd < 20 else 'This elevated drawdown requires careful position sizing and risk management.'}
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Tail Risk & Outliers
                    </h4>
                    <p style="margin-bottom: 20px;">
                        Value at Risk (VaR 95%): <strong style="color: #ffffff;">{var_95:.2f}%</strong> ‚Äì 
                        95% of trades lose less than this amount.
                        Conditional VaR (CVaR): <strong style="color: #ffffff;">{cvar_95:.2f}%</strong> ‚Äì 
                        expected loss in worst 5% of outcomes.
                        The tail ratio of <strong style="color: #ffffff;">{tail_ratio:.2f}</strong> 
                        {'indicates strong positive skew (upside potential exceeds downside risk)' if tail_ratio > 1.5 else 'suggests balanced tail risk' if tail_ratio > 0.8 else 'reveals concerning downside tail risk'}.
                        Outlier analysis: <strong style="color: #ffffff;">{len(outliers)}</strong> outliers detected 
                        ({outlier_win_ratio*100:.0f}% wins, {outlier_loss_ratio*100:.0f}% losses).
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Optimization Strategies
                    </h4>
                    <p style="margin-bottom: 20px;">
                        <strong style="color: #ffffff;">Position Sizing:</strong> {'Consider Kelly Criterion position sizing: {kelly_pct*100:.1f}% of capital per trade (or {kelly_pct*50:.1f}% for half-Kelly safety margin)' if kelly_pct > 0 else 'Implement fixed fractional sizing given current metrics'}.<br><br>

                        <strong style="color: #ffffff;">Stop Loss Optimization:</strong> {'Current stops are effective; analyze trade duration to identify premature exits' if max_dd < 15 else 'Tighten stops to reduce drawdown depth, or widen to avoid noise-driven exits'}.<br><br>

                        <strong style="color: #ffffff;">Take Profit Enhancement:</strong> {'Consider trailing stops to capture extended moves given positive skew' if skewness > 0.5 else 'Fixed profit targets appear optimal; avoid premature exits' if risk_reward > 2 else 'Scale out of winners to improve risk-reward ratio'}.<br><br>

                        <strong style="color: #ffffff;">Entry Timing:</strong> {'Focus on high-conviction setups to maintain win rate' if win_rate > 55 else 'Refine entry criteria to improve directional accuracy' if win_rate < 45 else 'Current entry logic is well-calibrated'}.<br><br>

                        <strong style="color: #ffffff;">Risk-Reward Target:</strong> {'Excellent current ratio of {risk_reward:.2f}:1; maintain this edge' if risk_reward > 2 else 'Target minimum 2:1 risk-reward; current {risk_reward:.2f}:1 needs improvement' if risk_reward < 2 else 'Solid {risk_reward:.2f}:1 ratio provides adequate edge'}.<br><br>

                        <strong style="color: #ffffff;">Risk of Ruin:</strong> {'Low probability of account ruin ({risk_of_ruin*100:.2f}%) - strategy is sustainable long-term' if risk_of_ruin < 0.05 else 'Moderate risk of ruin ({risk_of_ruin*100:.1f}%) - consider reducing position sizes' if risk_of_ruin < 0.20 else 'High risk of ruin ({risk_of_ruin*100:.0f}%) - significant risk management overhaul required'}.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Current Market Conditions ({current_date})
                    </h4>
                    <p style="margin-bottom: 0;">
                        <strong style="color: #ffffff;">‚ö†Ô∏è IMPORTANT:</strong> This backtest was conducted on historical data from {start_date} to {end_date}. 
                        Before deploying this strategy in live markets, analyze current macroeconomic conditions:<br><br>

                        <strong style="color: #ffffff;">üìä Key Economic Indicators to Monitor:</strong><br>
                        ‚Ä¢ <strong>Federal Funds Rate:</strong> Check current Fed policy rate and upcoming FOMC meetings<br>
                        ‚Ä¢ <strong>Inflation (CPI/PCE):</strong> Review latest Consumer Price Index and core PCE inflation<br>
                        ‚Ä¢ <strong>Unemployment Rate:</strong> Monitor labor market strength via BLS reports<br>
                        ‚Ä¢ <strong>GDP Growth:</strong> Assess economic expansion/contraction trends<br>
                        ‚Ä¢ <strong>Market Volatility (VIX):</strong> Evaluate current fear/greed levels<br>
                        ‚Ä¢ <strong>Currency Strength:</strong> Analyze {pair.split('/')[0]} and {pair.split('/')[1]} fundamental drivers<br><br>

                        <strong style="color: #ffffff;">üåç Geopolitical Factors:</strong><br>
                        ‚Ä¢ Central bank policy divergence between currencies<br>
                        ‚Ä¢ Trade agreements and tariff policies<br>
                        ‚Ä¢ Political stability in major economies<br>
                        ‚Ä¢ Global risk sentiment (risk-on vs risk-off)<br><br>

                        <strong style="color: #00d4ff;">üí° Strategy Adaptation Guidance:</strong><br>
                        {'‚Ä¢ High volatility environments may require tighter stops and smaller position sizes<br>‚Ä¢ Low volatility periods could benefit from wider targets to avoid premature exits<br>' if std_dev > 2 else '‚Ä¢ Current strategy parameters appear well-suited for moderate volatility<br>'}
                        ‚Ä¢ Monitor correlations: {pair} typically moves with {'risk sentiment and equity markets' if 'JPY' in pair or 'CHF' in pair else 'commodity prices and global trade' if 'AUD' in pair or 'NZD' in pair or 'CAD' in pair else 'interest rate differentials and economic data'}<br>
                        ‚Ä¢ Be prepared to pause trading during major central bank announcements or black swan events<br>
                        ‚Ä¢ Backtest performance may not reflect current market regime - validate with recent walk-forward data
                    </p>
                </div>

                <!-- RIGHT COLUMN: Statistical Analysis -->
                <div style="background: rgba(0, 0, 0, 0.3); 
                           border-radius: 12px; 
                           padding: 32px; 
                           border: 1px solid #222222;">

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 1px;">
                        Core Performance Metrics
                    </h4>

                    <!-- Metrics Table with Hover Explanations -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 32px;">
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row" 
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Total Return measures the overall percentage gain or loss from your initial investment. Exceptional: >20%, Good: >10%, Acceptable: >5%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Total Return ‚ìò</td>
                            <td style="padding: 10px 0; color: {perf_color}; text-align: right; font-weight: 700;">{total_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="CAGR (Compound Annual Growth Rate) shows annualized returns accounting for compounding. Excellent: >15%, Good: >10%, Minimum: >5%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">CAGR ‚ìò</td>
                            <td style="padding: 10px 0; color: {perf_color}; text-align: right; font-weight: 700;">{cagr:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Buy & Hold Return shows what you would have earned by simply holding the underlying asset with the same leverage. Compares passive vs active approach.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Buy & Hold Return ‚ìò</td>
                            <td style="padding: 10px 0; color: {'#00ff88' if buy_hold_return > 0 else '#ff3366'}; text-align: right;">{buy_hold_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Alpha measures outperformance vs the underlying asset. Positive alpha means your strategy beat the market. Good: >5%, Excellent: >10%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Alpha (Outperformance) ‚ìò</td>
                            <td style="padding: 10px 0; color: {'#00ff88' if strategy_outperformance > 0 else '#ff3366'}; text-align: right; font-weight: 700;">{strategy_outperformance:+.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Sharpe Ratio measures risk-adjusted returns (return per unit of volatility). Excellent: >2.0, Good: >1.5, Acceptable: >1.0, Poor: <0.5">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Sharpe Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{sharpe:.2f} <span style="color: {'#00ff88' if sharpe > 2 else '#00d4ff' if sharpe > 1.5 else '#888888' if sharpe > 1 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if sharpe > 2 else '‚òÖ‚òÖ' if sharpe > 1.5 else '‚òÖ' if sharpe > 1 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Sortino Ratio is like Sharpe but only penalizes downside volatility (losses), not upside. Excellent: >2.0, Good: >1.5, Acceptable: >1.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Sortino Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{sortino:.2f} <span style="color: {'#00ff88' if sortino > 2 else '#00d4ff' if sortino > 1.5 else '#888888' if sortino > 1 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if sortino > 2 else '‚òÖ‚òÖ' if sortino > 1.5 else '‚òÖ' if sortino > 1 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Calmar Ratio = CAGR / Max Drawdown. Measures return relative to worst loss. Excellent: >3.0, Good: >2.0, Acceptable: >1.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Calmar Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{calmar:.2f} <span style="color: {'#00ff88' if calmar > 3 else '#00d4ff' if calmar > 2 else '#888888' if calmar > 1 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if calmar > 3 else '‚òÖ‚òÖ' if calmar > 2 else '‚òÖ' if calmar > 1 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Profit Factor = Gross Profit / Gross Loss. Shows how much you make per dollar lost. Excellent: >2.0, Good: >1.5, Minimum: >1.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Profit Factor ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{profit_factor:.2f} <span style="color: {'#00ff88' if profit_factor > 2 else '#00d4ff' if profit_factor > 1.5 else '#888888' if profit_factor > 1 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if profit_factor > 2 else '‚òÖ‚òÖ' if profit_factor > 1.5 else '‚òÖ' if profit_factor > 1 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Payoff Ratio = Average Win / Average Loss. Your risk-reward per trade. Excellent: >2.5, Good: >2.0, Minimum: >1.5">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Payoff Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{payoff_ratio:.2f} <span style="color: {'#00ff88' if payoff_ratio > 2.5 else '#00d4ff' if payoff_ratio > 2 else '#888888' if payoff_ratio > 1.5 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if payoff_ratio > 2.5 else '‚òÖ‚òÖ' if payoff_ratio > 2 else '‚òÖ' if payoff_ratio > 1.5 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Win Rate shows percentage of profitable trades. High win rate (>60%) or high payoff ratio (>2.0) needed for profitability. Excellent: >55%, Good: >50%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Win Rate ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{win_rate:.1f}% <span style="color: {'#00ff88' if win_rate > 55 else '#00d4ff' if win_rate > 50 else '#888888' if win_rate > 45 else '#ff3366'}; font-size: 10px;">{'‚òÖ‚òÖ‚òÖ' if win_rate > 55 else '‚òÖ‚òÖ' if win_rate > 50 else '‚òÖ' if win_rate > 45 else '‚úó'}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Best Trade shows your largest winning trade as a percentage. Monitors if strategy relies on outliers vs consistent gains.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Best Trade ‚ìò</td>
                            <td style="padding: 10px 0; color: #00ff88; text-align: right;">{best_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Worst Trade shows your largest losing trade as a percentage. Should be controlled by stop losses. Warning if > 5% of account.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Worst Trade ‚ìò</td>
                            <td style="padding: 10px 0; color: #ff3366; text-align: right;">{worst_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Expectancy shows expected profit per trade in dollars. Positive expectancy = profitable strategy. Excellent: >$100, Good: >$50">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Expectancy ‚ìò</td>
                            <td style="padding: 10px 0; color: {'#00ff88' if expectancy > 0 else '#ff3366'}; text-align: right; font-weight: 700;">${expectancy:.2f}</td>
                        </tr>
                    </table>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                        Risk Metrics
                    </h4>

                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 32px;">
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Max Drawdown is the largest peak-to-trough decline. Measures worst case loss period. Conservative: <10%, Moderate: <20%, Aggressive: >20%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Max Drawdown ‚ìò</td>
                            <td style="padding: 10px 0; color: #ff3366; text-align: right;">{max_dd:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Ulcer Index measures both depth and duration of drawdowns. Lower is better. Excellent: <5, Good: <10, High Risk: >15">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Ulcer Index ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{ulcer_index:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Recovery Factor = Total Return / Max Drawdown. How well you recover from losses. Excellent: >3.0, Good: >2.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Recovery Factor ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{recovery_factor:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="VaR (Value at Risk) at 95% confidence: 95% of trades will lose less than this amount. Measures typical downside risk.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">VaR (95%) ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{var_95:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="CVaR (Conditional VaR) shows expected loss in the worst 5% of outcomes. Measures tail risk. Good: <-3%, Concerning: <-5%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">CVaR (95%) ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{cvar_95:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Tail Ratio = 95th percentile gain / 5th percentile loss. Measures upside vs downside extremes. Good: >1.5, Excellent: >2.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Tail Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{tail_ratio:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Gain-to-Pain Ratio = Sum of gains / Sum of losses. Similar to profit factor. Excellent: >2.0, Good: >1.5, Minimum: >1.0">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Gain-to-Pain ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{gain_to_pain:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Common Sense Ratio = Profit Factor - 1. Simplified measure of edge. Positive means profitable. >1.0 is good, >2.0 is excellent.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Common Sense Ratio ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{common_sense_ratio:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Risk of Ruin estimates probability of losing entire account. Based on Kelly Criterion. Excellent: <5%, Acceptable: <20%, Dangerous: >50%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Risk of Ruin ‚ìò</td>
                            <td style="padding: 10px 0; color: {'#00ff88' if risk_of_ruin < 0.05 else '#ff3366'}; text-align: right;">{risk_of_ruin*100:.2f}%</td>
                        </tr>
                    </table>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
                        Return Distribution
                    </h4>

                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 32px;">
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Mean Return shows average return per trade in percentage terms. Should be positive for profitable strategies.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Mean Return per Trade ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{mean_return:.3f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Standard Deviation measures volatility of returns. Lower is more consistent. Low: <2%, Moderate: 2-4%, High: >4%">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Std Deviation ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{std_dev:.3f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Variance is the squared standard deviation. Measures dispersion of returns from the mean.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Variance ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{variance:.3f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Skewness measures asymmetry. Positive (>0.5) = occasional big wins (good). Negative (<-0.5) = occasional big losses (bad). Zero = symmetric.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Skewness ‚ìò</td>
                            <td style="padding: 10px 0; color: {'#00ff88' if skewness > 0 else '#ff3366'}; text-align: right;">{skewness:.3f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Kurtosis measures tail heaviness. High (>3) = more extreme events. Low (<3) = fewer outliers. Normal distribution = 3.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Kurtosis ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{kurtosis:.3f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222; position: relative;" class="metric-row"
                            onmouseover="this.style.background='rgba(255,255,255,0.03)'" 
                            onmouseout="this.style.background='transparent'"
                            title="Kelly Criterion shows optimal position size as % of capital per trade. Use half-Kelly for safety. Negative = strategy needs work.">
                            <td style="padding: 10px 0; color: #888888; cursor: help;">Kelly Criterion % ‚ìò</td>
                            <td style="padding: 10px 0; color: #ffffff; text-align: right;">{kelly_pct*100:.2f}%</td>
                        </tr>
                    </table>

                    <div style="background: rgba(255, 255, 255, 0.02); 
                               border-left: 3px solid #00d4ff; 
                               padding: 16px; 
                               border-radius: 6px; 
                               font-size: 12px; 
                               line-height: 1.7;
                               color: #b0b0b0;
                               margin-bottom: 24px;">
                        <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">INTERPRETATION:</strong>
                        <strong>Skewness ({skewness:.2f}):</strong> {'Positive skew indicates more frequent small losses with occasional large wins (desirable)' if skewness > 0.5 else 'Negative skew suggests frequent small wins with occasional large losses (risk concern)' if skewness < -0.5 else 'Near-zero skew shows symmetric return distribution'}.<br><br>

                        <strong>Kurtosis ({kurtosis:.2f}):</strong> {'High kurtosis indicates fat tails - higher probability of extreme outcomes' if kurtosis > 3 else 'Normal kurtosis suggests typical market behavior' if kurtosis > 2 else 'Low kurtosis indicates thin tails - fewer extreme events'}.<br><br>

                        <strong>CVaR ({cvar_95:.2f}%):</strong> In the worst 5% of trading days, expect losses around this magnitude. {'Well-controlled tail risk' if abs(cvar_95) < 3 else 'Moderate tail risk exposure' if abs(cvar_95) < 5 else 'Significant tail risk - use protective stops'}.<br><br>

                        <strong>Kelly ({kelly_pct*100:.1f}%):</strong> {'Optimal position size per trade. Half-Kelly ({kelly_pct*50:.1f}%) recommended for safety' if kelly_pct > 0 else 'Negative Kelly suggests strategy needs refinement before position sizing'}.
                    </div>

                    <!-- Visual Ratio Comparison Charts -->
                    <h4 style="color: #ffffff; font-size: 14px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
                        Performance vs Standards
                    </h4>

                    <!-- Sharpe Ratio Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Sharpe Ratio</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{sharpe:.2f}</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">POOR</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">GOOD</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(sharpe/3*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#ff3366' if sharpe < 0 else '#00ff88'}; box-shadow: 0 0 10px {'#ff3366' if sharpe < 0 else '#00ff88'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>1.0</span><span>2.0</span><span>3.0+</span>
                        </div>
                    </div>

                    <!-- Sortino Ratio Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Sortino Ratio</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{sortino:.2f}</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">POOR</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">GOOD</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(sortino/3*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#ff3366' if sortino < 0 else '#00d4ff'}; box-shadow: 0 0 10px {'#ff3366' if sortino < 0 else '#00d4ff'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>1.0</span><span>2.0</span><span>3.0+</span>
                        </div>
                    </div>

                    <!-- Profit Factor Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Profit Factor</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{profit_factor:.2f}</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">LOSING</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">GOOD</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(profit_factor/3*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#ff3366' if profit_factor < 1 else '#b967ff'}; box-shadow: 0 0 10px {'#ff3366' if profit_factor < 1 else '#b967ff'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>1.0</span><span>2.0</span><span>3.0+</span>
                        </div>
                    </div>

                    <!-- Win Rate Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Win Rate</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{win_rate:.1f}%</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 40%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">POOR</div>
                            </div>
                            <div style="position: absolute; left: 40%; top: 0; height: 100%; width: 30%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">ACCEPTABLE</div>
                            </div>
                            <div style="position: absolute; left: 70%; top: 0; height: 100%; width: 30%;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(win_rate, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if win_rate > 55 else '#00d4ff' if win_rate > 50 else '#ffcc00' if win_rate > 45 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if win_rate > 55 else '#00d4ff' if win_rate > 50 else '#ffcc00' if win_rate > 45 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0%</span><span>40%</span><span>70%</span><span>100%</span>
                        </div>
                    </div>

                    <!-- Payoff Ratio (Avg Win / Avg Loss) Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Payoff Ratio (Avg Win/Loss)</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{payoff_ratio:.2f}:1</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 40%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">POOR</div>
                            </div>
                            <div style="position: absolute; left: 40%; top: 0; height: 100%; width: 30%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">GOOD</div>
                            </div>
                            <div style="position: absolute; left: 70%; top: 0; height: 100%; width: 30%;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(payoff_ratio/4*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if payoff_ratio > 2.5 else '#00d4ff' if payoff_ratio > 2 else '#ffcc00' if payoff_ratio > 1.5 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if payoff_ratio > 2.5 else '#00d4ff' if payoff_ratio > 2 else '#ffcc00' if payoff_ratio > 1.5 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>1.5</span><span>2.5</span><span>4.0+</span>
                        </div>
                    </div>

                    <!-- Average Win Size Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Avg Win Size (% of Capital)</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{(avg_win/initial_balance*100):.2f}%</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">SMALL</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">OPTIMAL</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #ffcc00; text-align: center; padding-top: 4px;">LARGE</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min((avg_win/initial_balance*100)/6*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if 1 <= (avg_win/initial_balance*100) <= 4 else '#ffcc00'}; box-shadow: 0 0 10px {'#00ff88' if 1 <= (avg_win/initial_balance*100) <= 4 else '#ffcc00'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0%</span><span>2%</span><span>4%</span><span>6%+</span>
                        </div>
                    </div>

                    <!-- Average Loss Size Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Avg Loss Size (% of Capital)</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{abs(avg_loss/initial_balance*100):.2f}%</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">CONTROLLED</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #ffcc00; text-align: center; padding-top: 4px;">MODERATE</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">EXCESSIVE</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(abs(avg_loss/initial_balance*100)/6*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if abs(avg_loss/initial_balance*100) < 2 else '#ffcc00' if abs(avg_loss/initial_balance*100) < 4 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if abs(avg_loss/initial_balance*100) < 2 else '#ffcc00' if abs(avg_loss/initial_balance*100) < 4 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0%</span><span>2%</span><span>4%</span><span>6%+</span>
                        </div>
                    </div>

                    <!-- Max Drawdown Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Max Drawdown</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{max_dd:.2f}%</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 25%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: 25%; top: 0; height: 100%; width: 25%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">MODERATE</div>
                            </div>
                            <div style="position: absolute; left: 50%; top: 0; height: 100%; width: 50%;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">HIGH RISK</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(abs(max_dd)/50*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if abs(max_dd) < 10 else '#00d4ff' if abs(max_dd) < 20 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if abs(max_dd) < 10 else '#00d4ff' if abs(max_dd) < 20 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0%</span><span>-10%</span><span>-20%</span><span>-50%+</span>
                        </div>
                    </div>

                    <!-- Average Trade Duration Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Avg Trade Duration</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{avg_trade_duration:.1f}h</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 25%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">SCALPING</div>
                            </div>
                            <div style="position: absolute; left: 25%; top: 0; height: 100%; width: 25%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">DAY TRADE</div>
                            </div>
                            <div style="position: absolute; left: 50%; top: 0; height: 100%; width: 25%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">SWING</div>
                            </div>
                            <div style="position: absolute; left: 75%; top: 0; height: 100%; width: 25%;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">POSITION</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(avg_trade_duration/200*100, 100))}%; top: -2px; width: 3px; height: 24px; background: #00d4ff; box-shadow: 0 0 10px #00d4ff;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>&lt;1h</span><span>24h</span><span>1wk</span><span>200h+</span>
                        </div>
                    </div>

                    <!-- Longest Trade vs Average Duration Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Longest Trade vs Average</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{(max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0):.1f}x</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 40%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">CONSISTENT</div>
                            </div>
                            <div style="position: absolute; left: 40%; top: 0; height: 100%; width: 30%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">MODERATE</div>
                            </div>
                            <div style="position: absolute; left: 70%; top: 0; height: 100%; width: 30%;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">HIGH VARIANCE</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min((max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0)/10*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if (max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0) < 3 else '#ffcc00' if (max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0) < 5 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if (max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0) < 3 else '#ffcc00' if (max_trade_duration/avg_trade_duration if avg_trade_duration > 0 else 0) < 5 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>1x</span><span>3x</span><span>7x</span><span>10x+</span>
                        </div>
                    </div>

                    <!-- Win Duration vs Loss Duration Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Avg Win Duration vs Loss Duration</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">Win: {avg_win_duration:.1f}h | Loss: {avg_loss_duration:.1f}h</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 40%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">LOSSES LONGER</div>
                            </div>
                            <div style="position: absolute; left: 40%; top: 0; height: 100%; width: 20%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">EQUAL</div>
                            </div>
                            <div style="position: absolute; left: 60%; top: 0; height: 100%; width: 40%;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">WINS LONGER</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(40 + (avg_win_duration - avg_loss_duration) / max(avg_win_duration, avg_loss_duration, 1) * 30, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if avg_win_duration > avg_loss_duration else '#ff3366' if avg_loss_duration > avg_win_duration else '#ffcc00'}; box-shadow: 0 0 10px {'#00ff88' if avg_win_duration > avg_loss_duration else '#ff3366' if avg_loss_duration > avg_win_duration else '#ffcc00'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>Loss 2x</span><span>Equal</span><span>Win 2x</span>
                        </div>
                    </div>

                    <!-- Consecutive Win Streak Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Max Consecutive Wins</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{max_win_streak} trades</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">LOW</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">GOOD</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(max_win_streak/15*100, 100))}%; top: -2px; width: 3px; height: 24px; background: #00ff88; box-shadow: 0 0 10px #00ff88;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>5</span><span>10</span><span>15+</span>
                        </div>
                    </div>

                    <!-- Consecutive Loss Streak Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Max Consecutive Losses</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{max_loss_streak} trades</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">MODERATE</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">CONCERNING</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(max_loss_streak/15*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if max_loss_streak < 5 else '#ffcc00' if max_loss_streak < 10 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if max_loss_streak < 5 else '#ffcc00' if max_loss_streak < 10 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>5</span><span>10</span><span>15+</span>
                        </div>
                    </div>

                    <!-- Risk of Ruin Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Risk of Ruin</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{risk_of_ruin*100:.2f}%</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 20%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">EXCELLENT</div>
                            </div>
                            <div style="position: absolute; left: 20%; top: 0; height: 100%; width: 30%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">ACCEPTABLE</div>
                            </div>
                            <div style="position: absolute; left: 50%; top: 0; height: 100%; width: 50%;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">DANGEROUS</div>
                            </div>
                            <div style="position: absolute; left: {max(0, min(risk_of_ruin*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if risk_of_ruin < 0.05 else '#ffcc00' if risk_of_ruin < 0.20 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if risk_of_ruin < 0.05 else '#ffcc00' if risk_of_ruin < 0.20 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0%</span><span>5%</span><span>20%</span><span>100%</span>
                        </div>
                    </div>

                    <!-- Skewness Bar (centered at 0) -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Skewness (Distribution Asymmetry)</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{skewness:.2f}</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 50%; border-right: 1px solid #ff3366;">
                                <div style="font-size: 8px; color: #ff3366; text-align: center; padding-top: 4px;">NEGATIVE</div>
                            </div>
                            <div style="position: absolute; left: 50%; top: 0; height: 100%; width: 50%;">
                                <div style="font-size: 8px; color: #00ff88; text-align: center; padding-top: 4px;">POSITIVE</div>
                            </div>
                            <!-- Clamp between 0% and 100%, but always show marker -->
                            <div style="position: absolute; left: {max(0, min(50 + skewness*25, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#00ff88' if skewness > 0 else '#ff3366'}; box-shadow: 0 0 10px {'#00ff88' if skewness > 0 else '#ff3366'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>-2.0</span><span>0</span><span>+2.0</span>
                        </div>
                    </div>

                    <!-- Kurtosis Bar -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-size: 11px; color: #888888;">Kurtosis (Tail Risk)</span>
                            <span style="font-size: 11px; color: #ffffff; font-weight: 700;">{kurtosis:.2f}</span>
                        </div>
                        <div style="background: #222222; height: 20px; border-radius: 4px; position: relative; overflow: visible;">
                            <div style="position: absolute; left: 0; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">LOW</div>
                            </div>
                            <div style="position: absolute; left: 33.33%; top: 0; height: 100%; width: 33.33%; border-right: 1px solid #000;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">NORMAL</div>
                            </div>
                            <div style="position: absolute; left: 66.66%; top: 0; height: 100%; width: 33.34%;">
                                <div style="font-size: 8px; color: #666; text-align: center; padding-top: 4px;">HIGH (FAT TAILS)</div>
                            </div>
                            <!-- Clamp between 0% and 100%, handle negative values at 0 -->
                            <div style="position: absolute; left: {max(0, min(abs(kurtosis)/6*100, 100))}%; top: -2px; width: 3px; height: 24px; background: {'#ff3366' if abs(kurtosis) > 4 else '#ffcc00' if abs(kurtosis) > 3 else '#00ff88'}; box-shadow: 0 0 10px {'#ff3366' if abs(kurtosis) > 4 else '#ffcc00' if abs(kurtosis) > 3 else '#00ff88'};"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 9px; color: #666;">
                            <span>0</span><span>3.0 (Normal)</span><span>6.0+</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        """

        return analysis_html
        """
        Generate comprehensive AI-powered analysis of strategy performance
        Two-column layout: Verbal analysis on left, Statistical metrics on right
        """
        if trades_df.empty:
            return "<p style='color: #888888;'>No trades available for analysis.</p>"

        # Calculate key metrics
        total_return = metrics.get('total_return_pct', 0)
        win_rate = metrics.get('win_rate', 0)
        profit_factor = metrics.get('profit_factor', 0)
        sharpe = metrics.get('sharpe_ratio', 0)
        sortino = metrics.get('sortino_ratio', 0)
        max_dd = metrics.get('max_drawdown_pct', 0)
        total_trades = len(trades_df)
        avg_win = metrics.get('avg_win', 0)
        avg_loss = metrics.get('avg_loss', 0)
        final_balance = metrics.get('final_balance', initial_balance)

        # Calculate additional statistics
        import numpy as np
        returns = trades_df['monetary_pnl'].values
        returns_pct = (returns / initial_balance) * 100

        std_dev = np.std(returns_pct)
        variance = np.var(returns_pct)
        skewness = float(np.mean(((returns_pct - np.mean(returns_pct)) / std_dev) ** 3)) if std_dev > 0 else 0
        kurtosis = float(np.mean(((returns_pct - np.mean(returns_pct)) / std_dev) ** 4)) if std_dev > 0 else 0

        # Winning vs losing statistics
        win_trades = trades_df[trades_df['monetary_pnl'] > 0]
        loss_trades = trades_df[trades_df['monetary_pnl'] <= 0]

        wins_count = len(win_trades)
        losses_count = len(loss_trades)

        # Calculate buy & hold comparison
        if not trades_df.empty:
            buy_hold_return = total_return  # Simplified - same growth rate
            strategy_outperformance = total_return - buy_hold_return
        else:
            buy_hold_return = 0
            strategy_outperformance = 0

        # Performance assessment
        if total_return > 20:
            performance = "exceptional"
            perf_color = "#00ff88"
        elif total_return > 10:
            performance = "strong"
            perf_color = "#00ff88"
        elif total_return > 0:
            performance = "positive"
            perf_color = "#00d4ff"
        else:
            performance = "concerning"
            perf_color = "#ff3366"

        # Risk-reward ratio
        risk_reward = abs(avg_win / avg_loss) if avg_loss != 0 else 0

        # Win streak analysis
        trades_df_copy = trades_df.copy()
        trades_df_copy['is_win'] = (trades_df_copy['monetary_pnl'] > 0).astype(int)

        # Calculate streaks
        streak_changes = trades_df_copy['is_win'].diff().fillna(0) != 0
        streak_ids = streak_changes.cumsum()
        streaks = trades_df_copy.groupby([streak_ids, 'is_win']).size()

        max_win_streak = int(streaks[streaks.index.get_level_values(1) == 1].max()) if any(streaks.index.get_level_values(1) == 1) else 0
        max_loss_streak = int(streaks[streaks.index.get_level_values(1) == 0].max()) if any(streaks.index.get_level_values(1) == 0) else 0

        # Expectancy
        expectancy = (win_rate / 100 * avg_win) + ((100 - win_rate) / 100 * avg_loss)

        # Monthly performance variability
        trades_df_copy['month'] = trades_df_copy['exit_time'].dt.to_period('M')
        if len(trades_df_copy['month'].unique()) > 1:
            monthly_returns = trades_df_copy.groupby('month')['monetary_pnl'].sum()
            monthly_std = monthly_returns.std()
            monthly_mean = monthly_returns.mean()
        else:
            monthly_std = 0
            monthly_mean = 0

        analysis_html = f"""
        <div style="background: linear-gradient(135deg, #161616 0%, #1a1a1a 100%); 
                    border-radius: 16px; 
                    padding: 40px; 
                    border: 1px solid #222222; 
                    margin-bottom: 60px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
            <h3 style="font-size: 18px; 
                       font-weight: 700; 
                       color: {perf_color}; 
                       margin-bottom: 32px; 
                       text-transform: uppercase; 
                       letter-spacing: 1.5px;
                       display: flex;
                       align-items: center;
                       gap: 12px;">
                <span style="width: 4px; height: 24px; background: {perf_color}; border-radius: 2px;"></span>
                AI PERFORMANCE ANALYSIS
            </h3>

            <!-- Two Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px;">

                <!-- LEFT COLUMN: Verbal Analysis -->
                <div style="color: #e0e0e0; font-size: 14px; line-height: 1.9; font-weight: 300;">

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">
                        Performance Overview
                    </h4>
                    <p style="margin-bottom: 20px;">
                        The <strong style="color: #ffffff;">{strategy_name}</strong> strategy demonstrates 
                        <strong style="color: {perf_color};">{performance}</strong> performance, achieving a 
                        <strong style="color: {perf_color};">{total_return:.2f}%</strong> total return 
                        from an initial balance of <strong style="color: #ffffff;">${initial_balance:,.0f}</strong> to 
                        <strong style="color: {perf_color};">${final_balance:,.0f}</strong> across 
                        <strong style="color: #ffffff;">{total_trades}</strong> trades.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Strategy vs Buy & Hold
                    </h4>
                    <p style="margin-bottom: 20px;">
                        {'The active trading strategy <strong style="color: #00ff88;">outperformed</strong> a passive buy & hold approach. ' if strategy_outperformance > 0 else 'The active strategy <strong style="color: #ff3366;">underperformed</strong> relative to buy & hold. '}
                        This {'justifies the added complexity and transaction costs of active trading' if strategy_outperformance > 0 else 'suggests passive holding may be more efficient for this market'}.
                        The strategy's ability to {'capitalize on price movements and limit downside exposure demonstrates clear alpha generation' if total_return > buy_hold_return and max_dd < 15 else 'manage risk while seeking returns is evident, though optimization opportunities exist' if total_return > 0 else 'generate consistent returns requires refinement'}.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Win Rate & Consistency
                    </h4>
                    <p style="margin-bottom: 20px;">
                        With a win rate of <strong style="color: #ffffff;">{win_rate:.1f}%</strong> 
                        ({wins_count} wins vs {losses_count} losses), the strategy {'demonstrates strong directional accuracy' if win_rate > 55 else 'maintains adequate win frequency' if win_rate > 45 else 'requires larger wins to offset the lower hit rate'}. 
                        The maximum winning streak of <strong style="color: #ffffff;">{max_win_streak}</strong> trades 
                        versus the maximum losing streak of <strong style="color: #ffffff;">{max_loss_streak}</strong> trades 
                        indicates {'healthy momentum capture with controlled drawdown periods' if max_win_streak > max_loss_streak * 1.5 else 'balanced performance with typical market variability' if max_win_streak >= max_loss_streak else 'vulnerability to extended losing periods that should be monitored'}.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Risk Management
                    </h4>
                    <p style="margin-bottom: 20px;">
                        The strategy exhibits a maximum drawdown of <strong style="color: #ffffff;">{max_dd:.2f}%</strong>, 
                        which falls into the {'conservative' if max_dd < 10 else 'moderate' if max_dd < 20 else 'aggressive'} risk category. 
                        {'This low drawdown indicates excellent capital preservation and risk control.' if max_dd < 10 else 'This moderate drawdown suggests balanced risk-taking appropriate for most trading accounts.' if max_dd < 20 else 'This elevated drawdown requires careful position sizing and risk management.'}
                        The Sharpe ratio of <strong style="color: #ffffff;">{sharpe:.2f}</strong> 
                        {'demonstrates excellent risk-adjusted returns (>2.0 is exceptional)' if sharpe > 2 else 'indicates good risk-adjusted performance (>1.0 is favorable)' if sharpe > 1 else 'suggests room for improvement in risk-adjusted returns' if sharpe > 0 else 'reveals negative risk-adjusted performance requiring strategy revision'}.
                    </p>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 16px; margin-top: 28px; text-transform: uppercase; letter-spacing: 1px;">
                        Optimization Strategies
                    </h4>
                    <p style="margin-bottom: 0;">
                        <strong style="color: #ffffff;">Position Sizing:</strong> {'Consider increasing position size given the strong risk-adjusted returns' if sharpe > 1.5 and max_dd < 15 else 'Implement dynamic position sizing based on market volatility' if std_dev > 2 else 'Current sizing appears appropriate for risk profile'}.<br><br>

                        <strong style="color: #ffffff;">Stop Loss Optimization:</strong> {'Current stops are effective; analyze trade duration to identify premature exits' if max_dd < 15 else 'Tighten stops to reduce drawdown depth, or widen to avoid noise-driven exits'}.<br><br>

                        <strong style="color: #ffffff;">Take Profit Enhancement:</strong> {'Consider trailing stops to capture extended moves given positive skew' if skewness > 0.5 else 'Fixed profit targets appear optimal; avoid premature exits' if risk_reward > 2 else 'Scale out of winners to improve risk-reward ratio'}.<br><br>

                        <strong style="color: #ffffff;">Entry Timing:</strong> {'Focus on high-conviction setups to maintain win rate' if win_rate > 55 else 'Refine entry criteria to improve directional accuracy' if win_rate < 45 else 'Current entry logic is well-calibrated'}.<br><br>

                        <strong style="color: #ffffff;">Market Regime Filter:</strong> {'Add volatility filters to avoid low-probability market conditions' if monthly_std > 1000 else 'Strategy shows consistency across different periods'}.<br><br>

                        <strong style="color: #ffffff;">Risk-Reward Target:</strong> {'Excellent current ratio of {risk_reward:.2f}:1; maintain this edge' if risk_reward > 2 else 'Target minimum 2:1 risk-reward; current {risk_reward:.2f}:1 needs improvement' if risk_reward < 2 else 'Solid {risk_reward:.2f}:1 ratio provides adequate edge'}.
                    </p>
                </div>

                <!-- RIGHT COLUMN: Statistical Analysis -->
                <div style="background: rgba(0, 0, 0, 0.3); 
                           border-radius: 12px; 
                           padding: 32px; 
                           border: 1px solid #222222;">

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 24px; text-transform: uppercase; letter-spacing: 1px;">
                        Statistical Metrics
                    </h4>

                    <!-- Metrics Table -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 32px;">
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Total Return</td>
                            <td style="padding: 12px 0; color: {perf_color}; text-align: right; font-weight: 700;">{total_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Buy & Hold Return</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{buy_hold_return:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Alpha (Outperformance)</td>
                            <td style="padding: 12px 0; color: {'#00ff88' if strategy_outperformance > 0 else '#ff3366'}; text-align: right; font-weight: 700;">{strategy_outperformance:+.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Profit Factor</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{profit_factor:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Sharpe Ratio</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{sharpe:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Sortino Ratio</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{sortino:.2f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Win Rate</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{win_rate:.1f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Risk-Reward Ratio</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{risk_reward:.2f}:1</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Max Drawdown</td>
                            <td style="padding: 12px 0; color: #ff3366; text-align: right;">{max_dd:.2f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Trade Expectancy</td>
                            <td style="padding: 12px 0; color: {'#00ff88' if expectancy > 0 else '#ff3366'}; text-align: right; font-weight: 700;">${expectancy:.2f}</td>
                        </tr>
                    </table>

                    <h4 style="color: #ffffff; font-size: 15px; font-weight: 700; margin-bottom: 20px; margin-top: 24px; text-transform: uppercase; letter-spacing: 1px;">
                        Return Distribution
                    </h4>

                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 32px;">
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Mean Return per Trade</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{np.mean(returns_pct):.3f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Std Deviation</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{std_dev:.3f}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Variance</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{variance:.3f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Skewness</td>
                            <td style="padding: 12px 0; color: {'#00ff88' if skewness > 0 else '#ff3366'}; text-align: right;">{skewness:.3f}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #222222;">
                            <td style="padding: 12px 0; color: #888888;">Kurtosis</td>
                            <td style="padding: 12px 0; color: #ffffff; text-align: right;">{kurtosis:.3f}</td>
                        </tr>
                    </table>

                    <div style="background: rgba(255, 255, 255, 0.02); 
                               border-left: 3px solid #00d4ff; 
                               padding: 16px; 
                               border-radius: 6px; 
                               font-size: 12px; 
                               line-height: 1.7;
                               color: #b0b0b0;">
                        <strong style="color: #00d4ff; display: block; margin-bottom: 8px;">INTERPRETATION:</strong>
                        <strong>Skewness ({skewness:.2f}):</strong> {'Positive skew indicates more frequent small losses with occasional large wins (desirable)' if skewness > 0.5 else 'Negative skew suggests frequent small wins with occasional large losses (risk concern)' if skewness < -0.5 else 'Near-zero skew shows symmetric return distribution'}.<br><br>

                        <strong>Kurtosis ({kurtosis:.2f}):</strong> {'High kurtosis indicates fat tails - higher probability of extreme outcomes' if kurtosis > 3 else 'Normal kurtosis suggests typical market behavior' if kurtosis > 2 else 'Low kurtosis indicates thin tails - fewer extreme events'}.<br><br>

                        <strong>Std Deviation ({std_dev:.2f}%):</strong> {'High volatility - returns vary significantly between trades' if std_dev > 3 else 'Moderate volatility - typical for active trading' if std_dev > 1.5 else 'Low volatility - consistent returns across trades'}.<br><br>

                        <strong>Monthly Variability:</strong> {'High month-to-month variation (œÉ=${monthly_std:,.0f})' if monthly_std > 1000 else 'Stable monthly performance (œÉ=${monthly_std:,.0f})'}.
                    </div>
                </div>
            </div>
        </div>
        """

        return analysis_html

    @staticmethod
    def generate_report(metrics, trades_df, strategy_name, timeframe, pair, initial_balance, 
                       leverage, sl_pips, tp_pips, risk_pct, start_date, end_date, df=None, output_dir=None):

        from datetime import datetime
        import json
        import tempfile
        import os

        timestamp = datetime.now().strftime("%Y-%m-%d_%H%M%S")
        backtest_run_time = datetime.now().strftime("%B %d, %Y at %I:%M:%S %p")

        # Generate matplotlib charts and get base64 encoded images
        equity_chart_b64, strategy_vs_bh_chart_b64 = HTMLReportGenerator._generate_matplotlib_charts(
            trades_df, initial_balance, metrics
        )

        # Prepare chart data for Chart.js
        chart_data = HTMLReportGenerator._prepare_chart_data(trades_df, initial_balance, metrics)

        # FIX METRICS - Recalculate from trades_df
        if not trades_df.empty:
            final_balance = trades_df['balance'].iloc[-1]
            total_return_pct = ((final_balance - initial_balance) / initial_balance) * 100
            win_trades = trades_df[trades_df['monetary_pnl'] > 0]
            loss_trades = trades_df[trades_df['monetary_pnl'] <= 0]
            win_rate = (len(win_trades) / len(trades_df)) * 100 if len(trades_df) > 0 else 0
            avg_win = win_trades['monetary_pnl'].mean() if len(win_trades) > 0 else 0
            avg_loss = loss_trades['monetary_pnl'].mean() if len(loss_trades) > 0 else 0

            # Update metrics with correct values
            metrics['final_balance'] = final_balance
            metrics['total_return_pct'] = total_return_pct
            metrics['win_rate'] = win_rate
            metrics['total_trades'] = len(trades_df)
            metrics['avg_win'] = avg_win
            metrics['avg_loss'] = avg_loss

        # Metrics table
        metrics_table = HTMLReportGenerator.generate_metrics_table(metrics, initial_balance)

        # Generate AI analysis with backtest parameters
        ai_analysis = HTMLReportGenerator._generate_ai_analysis(
            metrics, trades_df, initial_balance, strategy_name, pair, timeframe,
            start_date, end_date, leverage, sl_pips, tp_pips, risk_pct
        )

        # Get strategy source code
        strategy_code = HTMLReportGenerator.get_strategy_code(strategy_name)

        # Generate trade table
        trade_table = HTMLReportGenerator.generate_trade_table(trades_df)

        html = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoHaus - {pair} Backtest Report</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        :root {{
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-card: #161616;
            --bg-card-hover: #1a1a1a;
            --border: #222222;
            --border-bright: #333333;
            --text-primary: #ffffff;
            --text-secondary: #888888;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-blue: #00d4ff;
            --accent-purple: #b967ff;
            --accent-yellow: #ffcc00;
        }}

        body {{
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }}

        /* Animated Background */
        .animated-bg {{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.03;
            background: 
                radial-gradient(circle at 20% 50%, var(--accent-green) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-blue) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, var(--accent-purple) 0%, transparent 50%);
            animation: pulse 15s ease-in-out infinite;
        }}

        @keyframes pulse {{
            0%, 100% {{ opacity: 0.03; }}
            50% {{ opacity: 0.06; }}
        }}

        .container {{
            max-width: 2000px;
            margin: 0 auto;
            padding: 40px 24px;
            position: relative;
            z-index: 1;
        }}

        /* Header */
        .header {{
            text-align: left;
            padding: 24px 32px;
            margin-bottom: 40px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }}

        .header h1 {{
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }}

        .header .subtitle {{
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            font-weight: 300;
        }}

        /* Stats Grid */
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 60px;
        }}

        .stat-card {{
            background: var(--bg-card);
            padding: 32px;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }}

        .stat-card::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-green);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }}

        .stat-card:hover {{
            background: var(--bg-card-hover);
            border-color: var(--border-bright);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 255, 136, 0.1);
        }}

        .stat-card:hover::before {{
            transform: scaleY(1);
        }}

        .stat-card.negative::before {{
            background: var(--accent-red);
        }}

        .stat-card:hover.negative {{
            box-shadow: 0 12px 40px rgba(255, 51, 102, 0.1);
        }}

        .stat-label {{
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }}

        .stat-value {{
            font-size: 36px;
            font-weight: 700;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
            color: var(--text-primary);
            line-height: 1.2;
        }}

        .stat-value.positive {{
            color: var(--accent-green);
        }}

        .stat-value.negative {{
            color: var(--accent-red);
        }}

        /* Chart Containers */
        .charts-section {{
            margin: 60px 0;
        }}

        .chart-row {{
            display: grid;
            gap: 24px;
            margin-bottom: 24px;
        }}

        .chart-row.full {{
            grid-template-columns: 1fr;
        }}

        .chart-row.four-col {{
            grid-template-columns: repeat(4, 1fr);
        }}

        .chart-container {{
            background: var(--bg-card);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }}

        .chart-container:hover {{
            border-color: var(--border-bright);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.08);
        }}

        /* Chart height classes - FIXED SIZES FOR PROPER RENDERING */
        .chart-container.extra-tall {{
            height: 600px;
        }}

        .chart-container.tall {{
            height: 450px;
        }}

        .chart-container.medium {{
            height: 400px;
        }}

        .chart-container.short {{
            height: 350px;
        }}

        /* Matplotlib image containers */
        .chart-container.matplotlib-chart {{
            padding: 20px;
            height: auto;
        }}

        .chart-container.matplotlib-chart img {{
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }}

        .chart-container::after {{
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--accent-green) 0%, transparent 70%);
            opacity: 0.02;
            pointer-events: none;
        }}

        .chart-title {{
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }}

        .chart-title::before {{
            content: '';
            width: 3px;
            height: 18px;
            background: var(--accent-green);
            border-radius: 2px;
        }}

        .chart-description {{
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.4;
            font-weight: 300;
        }}

        /* Chart Overlay Tooltip */
        .chart-overlay {{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            color: #ffffff;
            padding: 32px;
            border-radius: 16px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }}

        .chart-container:hover .chart-overlay {{
            opacity: 1;
        }}

        .chart-overlay h4 {{
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }}

        .chart-overlay p {{
            font-size: 13px;
            line-height: 1.8;
            margin-bottom: 12px;
            color: #e0e0e0;
        }}

        .chart-overlay .metric {{
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 6px 0;
            font-size: 12px;
            border-left: 3px solid var(--accent-green);
        }}

        .chart-overlay .metric.negative {{
            border-left-color: var(--accent-red);
        }}

        .chart-canvas-wrapper {{
            position: relative;
            width: 100%;
            height: calc(100% - 70px);
        }}

        .chart-canvas {{
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }}

        /* Trade Table */
        .trade-log {{
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid var(--border);
            margin-top: 60px;
        }}

        .trade-table {{
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            font-size: 13px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
        }}

        .trade-table thead {{
            background: var(--bg-secondary);
        }}

        .trade-table th {{
            padding: 16px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-green);
            font-weight: 700;
            border-bottom: 2px solid var(--border);
        }}

        .trade-table td {{
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }}

        .trade-table tbody tr {{
            transition: background 0.2s;
        }}

        .trade-table tbody tr:hover {{
            background: var(--bg-secondary);
        }}

        .positive-trade {{
            color: var(--accent-green);
            font-weight: 700;
        }}

        .negative-trade {{
            color: var(--accent-red);
            font-weight: 700;
        }}

        /* Collapsible Button */
        .collapsible {{
            background: #2a2a2a;
            color: #ffffff;
            cursor: pointer;
            padding: 14px 24px;
            border: 1px solid #444444;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            border-radius: 8px;
            margin-top: 20px;
            width: 300px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Helvetica Neue', Helvetica, sans-serif;
        }}

        .collapsible:hover {{
            background: #333333;
            border-color: #555555;
        }}

        .collapsible.active {{
            background: #333333;
        }}

        .content {{
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }}

        /* Responsive */
        @media (max-width: 1600px) {{
            .chart-row.four-col {{
                grid-template-columns: repeat(3, 1fr);
            }}
        }}

        @media (max-width: 1200px) {{
            .chart-row.four-col {{
                grid-template-columns: repeat(2, 1fr);
            }}
        }}

        @media (max-width: 768px) {{
            .chart-row.four-col {{
                grid-template-columns: 1fr;
            }}

            .stats-grid {{
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }}

            .stat-card {{
                padding: 20px;
            }}

            .stat-value {{
                font-size: 28px;
            }}

            .chart-container {{
                padding: 16px;
                min-height: 300px !important;
            }}
        }}

        @media (max-width: 480px) {{
            .stats-grid {{
                grid-template-columns: 1fr;
            }}

            .header {{
                padding: 16px 20px;
            }}

            .header h1 {{
                font-size: 11px;
            }}
        }}
    </style>
</head>
<body>
    <div class="animated-bg"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ALGOHAUS BACKTEST REPORT</h1>
            <div class="subtitle">{pair} ¬∑ {strategy_name} ¬∑ {timeframe}</div>
            <div class="subtitle" style="margin-top: 8px; font-size: 11px; color: #666666;">
                {start_date} to {end_date} ¬∑ Initial Balance: ${initial_balance:,.0f} ¬∑ Leverage: {leverage}x ¬∑ 
                SL: {sl_pips} pips ¬∑ TP: {tp_pips} pips ¬∑ Risk: {risk_pct}%
            </div>
            <div class="subtitle" style="margin-top: 6px; font-size: 10px; color: #555555; font-style: italic;">
                Backtest executed: {backtest_run_time}
            </div>
        </div>

        <!-- Performance Metrics -->
        {metrics_table}

        <!-- AI Analysis -->
        {ai_analysis}

        <!-- Charts -->
        <div class="charts-section">
            <!-- Equity Curve - Full Width Matplotlib -->
            <div class="chart-row full">
                <div class="chart-container extra-tall matplotlib-chart">
                    <h3 class="chart-title">EQUITY CURVE</h3>
                    <p class="chart-description">Portfolio value over time showing cumulative growth</p>
                    <img src="data:image/png;base64,{equity_chart_b64}" alt="Equity Curve">
                </div>
            </div>

            <!-- Strategy vs Buy & Hold - Full Width Matplotlib -->
            <div class="chart-row full">
                <div class="chart-container extra-tall matplotlib-chart">
                    <h3 class="chart-title">STRATEGY VS BUY & HOLD</h3>
                    <p class="chart-description">Active strategy performance compared to passive holding</p>
                    <img src="data:image/png;base64,{strategy_vs_bh_chart_b64}" alt="Strategy vs Buy & Hold">
                </div>
            </div>

            <!-- Four Column Charts Row 1 -->
            <div class="chart-row four-col">
                <div class="chart-container medium">
                    <h3 class="chart-title">DRAWDOWN</h3>
                    <p class="chart-description">Peak-to-trough decline</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="drawdownChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Drawdown Analysis</h4>
                        <p>Measures the peak-to-trough decline in your portfolio. Shows the pain of losing streaks and recovery periods.</p>
                        <div class="metric negative">Max Drawdown: Worst drop from peak</div>
                        <div class="metric">Recovery Time: How long to reach new highs</div>
                        <div class="metric">Target: Keep below 20% for healthy strategies</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">WIN/LOSS RATIO</h3>
                    <p class="chart-description">Proportion of wins vs losses</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="winLossChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Win/Loss Ratio</h4>
                        <p>Visual breakdown of winning vs losing trades. The ratio between green and red determines overall profitability potential.</p>
                        <div class="metric">Winning Trades: Green segment</div>
                        <div class="metric negative">Losing Trades: Red segment</div>
                        <div class="metric">Key Insight: Larger green = higher win rate, but check if wins are larger than losses</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">P&L DISTRIBUTION</h3>
                    <p class="chart-description">Frequency of profit/loss</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="distributionChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>P&L Distribution</h4>
                        <p>Shows how often you achieve different profit/loss amounts. Bell curve centered on positive = consistent profits.</p>
                        <div class="metric">Green bars: Profitable trades (right side)</div>
                        <div class="metric negative">Red bars: Losing trades (left side)</div>
                        <div class="metric">Ideal: More green bars, centered towards positive values</div>
                        <div class="metric">Warning: Heavy left tail = risk of large losses</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">MONTHLY RETURNS</h3>
                    <p class="chart-description">Month-over-month performance</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="monthlyChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Monthly Returns</h4>
                        <p>Performance broken down by month. Shows consistency and seasonal patterns in your strategy.</p>
                        <div class="metric">Green bars: Profitable months</div>
                        <div class="metric negative">Red bars: Losing months</div>
                        <div class="metric">Consistency Check: More green than red = winning strategy</div>
                        <div class="metric">Pattern Recognition: Identify seasonal trends or weak months</div>
                    </div>
                </div>
            </div>

            <!-- Four Column Charts Row 2 -->
            <div class="chart-row four-col">
                <div class="chart-container medium">
                    <h3 class="chart-title">ROLLING WIN RATE</h3>
                    <p class="chart-description">20-trade moving average</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="rollingWinChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Rolling Win Rate (20 Trades)</h4>
                        <p>Moving average of win percentage over 20-trade windows. Smooths out short-term noise to reveal true performance trends.</p>
                        <div class="metric">Target: Consistently above 50%</div>
                        <div class="metric">Upward Trend: Strategy improving over time</div>
                        <div class="metric negative">Downward Trend: Strategy degradation or market change</div>
                        <div class="metric">Volatility: Large swings suggest inconsistent performance</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">RETURNS DISTRIBUTION</h3>
                    <p class="chart-description">Per-trade return %</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="returnsDistChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Returns Distribution</h4>
                        <p>Histogram of percentage returns per trade. Shows the statistical profile of your strategy's performance.</p>
                        <div class="metric">Normal Distribution: Predictable, consistent returns</div>
                        <div class="metric">Positive Skew: More frequent small wins, rare big wins</div>
                        <div class="metric negative">Negative Skew: Beware of occasional large losses</div>
                        <div class="metric">Fat Tails: High risk of extreme outcomes (good or bad)</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">CUMULATIVE RETURNS</h3>
                    <p class="chart-description">Total % gain/loss over time</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="cumulativeReturnsChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Cumulative Returns %</h4>
                        <p>Total percentage gain or loss from your starting balance over time. The ultimate measure of strategy performance.</p>
                        <div class="metric">Upward Trend: Profitable strategy building wealth</div>
                        <div class="metric">Flat Periods: Consolidation or sideways markets</div>
                        <div class="metric negative">Sharp Drops: Losing streaks requiring investigation</div>
                        <div class="metric">Angle of Ascent: Steeper = faster compounding returns</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">BEST VS WORST</h3>
                    <p class="chart-description">Trade quartile breakdown</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="bestWorstChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Best vs Worst Trades</h4>
                        <p>Breaks down your trades into top 25%, middle 50%, and bottom 25% performers. Reveals if success depends on outliers.</p>
                        <div class="metric">Top 25% (Green): Your best winning trades</div>
                        <div class="metric">Middle 50% (Gray): Average performance</div>
                        <div class="metric negative">Bottom 25% (Red): Your worst trades</div>
                        <div class="metric">Balanced = Consistent strategy. Heavy top/bottom = outlier dependent</div>
                    </div>
                </div>
            </div>

            <!-- Four Column Charts Row 3 -->
            <div class="chart-row four-col">
                <div class="chart-container medium">
                    <h3 class="chart-title">ROLLING SHARPE</h3>
                    <p class="chart-description">Risk-adjusted returns (20)</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="rollingSharpeChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Rolling Sharpe Ratio (20 Trades)</h4>
                        <p>Measures return per unit of risk over 20-trade windows. Higher Sharpe = better risk-adjusted performance.</p>
                        <div class="metric">Sharpe > 2: Excellent risk-adjusted returns</div>
                        <div class="metric">Sharpe 1-2: Good performance</div>
                        <div class="metric">Sharpe < 1: Poor risk-reward balance</div>
                        <div class="metric negative">Declining Sharpe: Strategy losing edge or taking too much risk</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">ROLLING VOLATILITY</h3>
                    <p class="chart-description">20-trade std deviation</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="rollingVolatilityChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Rolling Volatility</h4>
                        <p>20-trade annualized standard deviation of returns. Measures how much your returns swing around the mean.</p>
                        <div class="metric negative">High Volatility: Large swings, higher risk</div>
                        <div class="metric">Low Volatility: Stable, predictable returns</div>
                        <div class="metric negative">Spikes: Often precede drawdowns or market stress</div>
                        <div class="metric">Rising Trend: Increasing uncertainty and risk exposure</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">TRADE DURATION</h3>
                    <p class="chart-description">Holding period distribution</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="tradeDurationChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Trade Duration Distribution</h4>
                        <p>Histogram of how long you hold each trade (in hours). Reveals if your actual holding times match strategy expectations.</p>
                        <div class="metric">Clustering: Most trades should group around expected duration</div>
                        <div class="metric">Long Tail: Trades exceeding expected time (stops not hit)</div>
                        <div class="metric negative">Very Short Duration: May indicate noise trading or tight stops</div>
                        <div class="metric">Wide Spread: Inconsistent trade management</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">WEEKDAY PERFORMANCE</h3>
                    <p class="chart-description">Avg P&L by day of week</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="weekdayPerfChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Weekday Performance</h4>
                        <p>Average profit/loss broken down by day of the week. Identifies if certain days consistently outperform or underperform.</p>
                        <div class="metric">Monday/Friday: Often show different patterns (week open/close)</div>
                        <div class="metric">Consistent Across Days: Strategy works in all market conditions</div>
                        <div class="metric negative">Weak Day: Consider avoiding trades on consistently poor days</div>
                        <div class="metric">Strong Day: Potential to increase position size on best days</div>
                    </div>
                </div>
            </div>

            <!-- Four Column Charts Row 4 - Win/Loss Analysis -->
            <div class="chart-row four-col">
                <div class="chart-container medium">
                    <h3 class="chart-title">WIN RATE OVER TIME</h3>
                    <p class="chart-description">Cumulative win percentage progression</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="winRateOverTimeChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Win Rate Over Time</h4>
                        <p>Shows how your win rate evolved throughout the backtest period. A stable or improving trend indicates consistent strategy performance.</p>
                        <div class="metric">Target: Above 50% for profitable strategies</div>
                        <div class="metric">Watch for: Declining trends that signal strategy degradation</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">AVG WIN DISTRIBUTION</h3>
                    <p class="chart-description">Distribution of winning trade sizes</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="avgWinDistChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Average Win Distribution</h4>
                        <p>Histogram showing the frequency and magnitude of winning trades. Reveals if wins are consistent or dominated by outliers.</p>
                        <div class="metric">Ideal: Normal distribution with consistent wins</div>
                        <div class="metric">Warning: Heavy right tail suggests dependence on rare big wins</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">AVG LOSS DISTRIBUTION</h3>
                    <p class="chart-description">Distribution of losing trade sizes</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="avgLossDistChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Average Loss Distribution</h4>
                        <p>Histogram showing the frequency and magnitude of losing trades. Critical for understanding risk exposure.</p>
                        <div class="metric negative">Risk Check: Losses should be controlled and consistent</div>
                        <div class="metric negative">Warning: Fat left tail indicates occasional catastrophic losses</div>
                    </div>
                </div>
                <div class="chart-container medium">
                    <h3 class="chart-title">WIN/LOSS COMPARISON</h3>
                    <p class="chart-description">Side-by-side avg win vs avg loss</p>
                    <div class="chart-canvas-wrapper">
                        <canvas id="winLossCompChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="chart-overlay">
                        <h4>Win/Loss Comparison</h4>
                        <p>Direct comparison of average winning trade size versus average losing trade size. Key for evaluating risk-reward ratio.</p>
                        <div class="metric">Risk-Reward Ratio: Avg Win / Avg Loss</div>
                        <div class="metric">Target: Ratio > 1.5 for sustainable profitability</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Code -->
        <div class="trade-log">
            <h3 class="chart-title">STRATEGY CODE</h3>
            <button class="collapsible">‚ñº CLICK TO VIEW STRATEGY CODE</button>
            <div class="content">
                <div style="background: #0a0a0a; border: 1px solid #222222; border-radius: 12px; padding: 24px; overflow-x: auto; margin-top: 24px;">
                    <pre style="margin: 0; color: #888888; font-family: 'Helvetica Neue', Helvetica, sans-serif; font-size: 12px; line-height: 1.6; white-space: pre-wrap;">{strategy_code}</pre>
                </div>
            </div>
        </div>

        <!-- Trade Log -->
        <div class="trade-log" style="margin-top: 32px;">
            <h3 class="chart-title">TRADE LOG</h3>
            <button class="collapsible">‚ñº CLICK TO VIEW ALL TRADES</button>
            <div class="content">
                {trade_table}
            </div>
        </div>
    </div>

    <script>
        // Chart.js Global Configuration - DARK THEME
        Chart.defaults.color = '#888888';
        Chart.defaults.borderColor = '#222222';
        Chart.defaults.backgroundColor = 'rgba(0, 255, 136, 0.1)';
        Chart.defaults.font.family = "'Helvetica Neue', Helvetica, Arial, sans-serif";
        Chart.defaults.font.size = 11;

        const chartData = {json.dumps(chart_data)};

        // Common chart options
        const commonOptions = {{
            responsive: true,
            maintainAspectRatio: false,
            plugins: {{
                legend: {{
                    display: true,
                    position: 'top',
                    labels: {{
                        color: '#ffffff',
                        font: {{
                            size: 11,
                            weight: '600'
                        }},
                        padding: 12,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }}
                }},
                tooltip: {{
                    backgroundColor: '#161616',
                    titleColor: '#00ff88',
                    bodyColor: '#ffffff',
                    borderColor: '#333333',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    titleFont: {{
                        size: 12,
                        weight: '700'
                    }},
                    bodyFont: {{
                        size: 11
                    }}
                }}
            }},
            scales: {{
                x: {{
                    grid: {{
                        display: true,
                        color: '#1a1a1a',
                        lineWidth: 1
                    }},
                    ticks: {{
                        color: '#888888',
                        font: {{
                            size: 9
                        }},
                        maxRotation: 45,
                        minRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 8
                    }},
                    border: {{
                        display: false
                    }}
                }},
                y: {{
                    grid: {{
                        display: true,
                        color: '#1a1a1a',
                        lineWidth: 1
                    }},
                    ticks: {{
                        color: '#888888',
                        font: {{
                            size: 9
                        }},
                        padding: 6
                    }},
                    border: {{
                        display: false
                    }}
                }}
            }}
        }};

        // 1. DRAWDOWN
        const drawdownCtx = document.getElementById('drawdownChart').getContext('2d');
        new Chart(drawdownCtx, {{
            type: 'line',
            data: {{
                labels: chartData.dates,
                datasets: [{{
                    label: 'Drawdown %',
                    data: chartData.drawdown,
                    borderColor: '#ff3366',
                    backgroundColor: 'rgba(255, 51, 102, 0.15)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 2. WIN/LOSS DONUT
        const winLossCtx = document.getElementById('winLossChart').getContext('2d');
        new Chart(winLossCtx, {{
            type: 'doughnut',
            data: {{
                labels: ['Wins', 'Losses'],
                datasets: [{{
                    data: [chartData.wins, chartData.losses],
                    backgroundColor: ['rgba(0, 255, 136, 0.8)', 'rgba(255, 51, 102, 0.8)'],
                    borderColor: ['#00ff88', '#ff3366'],
                    borderWidth: 2
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        position: 'bottom',
                        labels: {{
                            color: '#ffffff',
                            font: {{ size: 11, weight: '600' }},
                            padding: 16
                        }}
                    }}
                }},
                cutout: '65%'
            }}
        }});

        // 3. P&L DISTRIBUTION
        const distributionCtx = document.getElementById('distributionChart').getContext('2d');
        new Chart(distributionCtx, {{
            type: 'bar',
            data: {{
                labels: chartData.pnl_bins,
                datasets: [{{
                    label: 'Frequency',
                    data: chartData.pnl_counts,
                    backgroundColor: chartData.pnl_counts.map((_, i) => 
                        chartData.pnl_bins[i] >= 0 ? 'rgba(0, 255, 136, 0.7)' : 'rgba(255, 51, 102, 0.7)'
                    ),
                    borderWidth: 0,
                    borderRadius: 4
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 4. MONTHLY RETURNS
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {{
            type: 'bar',
            data: {{
                labels: chartData.months,
                datasets: [{{
                    label: 'Monthly Return %',
                    data: chartData.monthly_returns,
                    backgroundColor: chartData.monthly_returns.map(val =>
                        val >= 0 ? 'rgba(0, 255, 136, 0.7)' : 'rgba(255, 51, 102, 0.7)'
                    ),
                    borderWidth: 0,
                    borderRadius: 4
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 5. ROLLING WIN RATE
        const rollingWinCtx = document.getElementById('rollingWinChart').getContext('2d');
        new Chart(rollingWinCtx, {{
            type: 'line',
            data: {{
                labels: chartData.dates,
                datasets: [{{
                    label: 'Win Rate %',
                    data: chartData.rolling_win_rate,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }},
                scales: {{
                    ...commonOptions.scales,
                    y: {{ ...commonOptions.scales.y, min: 0, max: 100 }}
                }}
            }}
        }});

        // 6. RETURNS DISTRIBUTION
        const returnsDistCtx = document.getElementById('returnsDistChart').getContext('2d');
        new Chart(returnsDistCtx, {{
            type: 'bar',
            data: {{
                labels: chartData.returns_bins.map(v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%'),
                datasets: [{{
                    label: 'Trades',
                    data: chartData.returns_counts,
                    backgroundColor: chartData.returns_bins.map(v =>
                        v >= 0 ? 'rgba(0, 255, 136, 0.6)' : 'rgba(255, 51, 102, 0.6)'
                    ),
                    borderWidth: 0,
                    borderRadius: 3
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }},
                scales: {{
                    ...commonOptions.scales,
                    x: {{
                        ...commonOptions.scales.x,
                        ticks: {{
                            ...commonOptions.scales.x.ticks,
                            maxTicksLimit: 6
                        }}
                    }}
                }}
            }}
        }});

        // 7. CUMULATIVE RETURNS
        const cumulativeReturnsCtx = document.getElementById('cumulativeReturnsChart').getContext('2d');
        new Chart(cumulativeReturnsCtx, {{
            type: 'line',
            data: {{
                labels: chartData.dates,
                datasets: [{{
                    label: 'Cumulative %',
                    data: chartData.cumulative_returns,
                    borderColor: '#b967ff',
                    backgroundColor: 'rgba(185, 103, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 8. BEST VS WORST DONUT
        const bestWorstCtx = document.getElementById('bestWorstChart').getContext('2d');
        const totalTrades = chartData.wins + chartData.losses;
        const topQuartile = Math.ceil(totalTrades * 0.25);
        const avgTrades = totalTrades - (topQuartile * 2);

        new Chart(bestWorstCtx, {{
            type: 'doughnut',
            data: {{
                labels: ['Top 25%', 'Average', 'Bottom 25%'],
                datasets: [{{
                    data: [topQuartile, avgTrades, topQuartile],
                    backgroundColor: ['rgba(0, 255, 136, 0.9)', 'rgba(136, 136, 136, 0.6)', 'rgba(255, 51, 102, 0.9)'],
                    borderColor: ['#00ff88', '#888888', '#ff3366'],
                    borderWidth: 2
                }}]
            }},
            options: {{
                responsive: true,
                maintainAspectRatio: false,
                plugins: {{
                    legend: {{
                        position: 'bottom',
                        labels: {{
                            color: '#ffffff',
                            font: {{ size: 10, weight: '600' }},
                            padding: 12
                        }}
                    }}
                }},
                cutout: '60%'
            }}
        }});

        // 9. ROLLING SHARPE
        const rollingSharpeCtx = document.getElementById('rollingSharpeChart').getContext('2d');
        new Chart(rollingSharpeCtx, {{
            type: 'line',
            data: {{
                labels: chartData.dates,
                datasets: [{{
                    label: 'Sharpe',
                    data: chartData.rolling_sharpe,
                    borderColor: '#ffcc00',
                    backgroundColor: 'rgba(255, 204, 0, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 10. ROLLING VOLATILITY
        const rollingVolatilityCtx = document.getElementById('rollingVolatilityChart').getContext('2d');
        new Chart(rollingVolatilityCtx, {{
            type: 'line',
            data: {{
                labels: chartData.dates,
                datasets: [{{
                    label: 'Volatility %',
                    data: chartData.rolling_volatility,
                    borderColor: '#ff3366',
                    backgroundColor: 'rgba(255, 51, 102, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 11. TRADE DURATION
        const tradeDurationCtx = document.getElementById('tradeDurationChart').getContext('2d');
        new Chart(tradeDurationCtx, {{
            type: 'bar',
            data: {{
                labels: chartData.trade_duration_bins.map(v => v.toFixed(1) + 'h'),
                datasets: [{{
                    label: 'Trades',
                    data: chartData.trade_duration_counts,
                    backgroundColor: 'rgba(0, 212, 255, 0.7)',
                    borderWidth: 0,
                    borderRadius: 4
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }}
                }}
            }}
        }});

        // 12. WEEKDAY PERFORMANCE
        if (Object.keys(chartData.weekday_returns).length > 0) {{
            const weekdayPerfCtx = document.getElementById('weekdayPerfChart').getContext('2d');
            const weekdays = Object.keys(chartData.weekday_returns);
            const weekdayValues = weekdays.map(d => chartData.weekday_returns[d]);

            new Chart(weekdayPerfCtx, {{
                type: 'bar',
                data: {{
                    labels: weekdays,
                    datasets: [{{
                        label: 'Avg P&L',
                        data: weekdayValues,
                        backgroundColor: weekdayValues.map(v =>
                            v >= 0 ? 'rgba(0, 255, 136, 0.7)' : 'rgba(255, 51, 102, 0.7)'
                        ),
                        borderWidth: 0,
                        borderRadius: 4
                    }}]
                }},
                options: {{
                    ...commonOptions,
                    plugins: {{
                        ...commonOptions.plugins,
                        legend: {{ display: false }}
                    }}
                }}
            }});
        }}

        // 13. WIN RATE OVER TIME (Cumulative)
        if (chartData.dates.length > 0) {{
            const winRateOverTimeCtx = document.getElementById('winRateOverTimeChart').getContext('2d');
            // Calculate cumulative win rate
            let cumulativeWins = 0;
            let cumulativeTrades = 0;
            const cumulativeWinRate = chartData.dates.map((date, idx) => {{
                if (chartData.equity[idx] > (chartData.equity[idx-1] || chartData.equity[0])) {{
                    cumulativeWins++;
                }}
                cumulativeTrades++;
                return (cumulativeWins / cumulativeTrades) * 100;
            }});

            new Chart(winRateOverTimeCtx, {{
                type: 'line',
                data: {{
                    labels: chartData.dates,
                    datasets: [{{
                        label: 'Cumulative Win Rate %',
                        data: cumulativeWinRate,
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }}]
                }},
                options: {{
                    ...commonOptions,
                    plugins: {{
                        ...commonOptions.plugins,
                        legend: {{ display: false }}
                    }},
                    scales: {{
                        ...commonOptions.scales,
                        y: {{ ...commonOptions.scales.y, min: 0, max: 100 }}
                    }}
                }}
            }});
        }}

        // 14. AVG WIN DISTRIBUTION
        if (chartData.wins > 0) {{
            const avgWinDistCtx = document.getElementById('avgWinDistChart').getContext('2d');
            // Filter only winning trades from pnl data
            const winningTrades = chartData.pnl_bins.map((bin, idx) => {{
                return bin > 0 ? chartData.pnl_counts[idx] : 0;
            }});

            new Chart(avgWinDistCtx, {{
                type: 'bar',
                data: {{
                    labels: chartData.pnl_bins.map(v => v > 0 ? '+$' + v.toFixed(0) : ''),
                    datasets: [{{
                        label: 'Winning Trades',
                        data: winningTrades,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: '#00ff88',
                        borderWidth: 1,
                        borderRadius: 4
                    }}]
                }},
                options: {{
                    ...commonOptions,
                    plugins: {{
                        ...commonOptions.plugins,
                        legend: {{ display: false }}
                    }}
                }}
            }});
        }}

        // 15. AVG LOSS DISTRIBUTION
        if (chartData.losses > 0) {{
            const avgLossDistCtx = document.getElementById('avgLossDistChart').getContext('2d');
            // Filter only losing trades from pnl data
            const losingTrades = chartData.pnl_bins.map((bin, idx) => {{
                return bin < 0 ? chartData.pnl_counts[idx] : 0;
            }});

            new Chart(avgLossDistCtx, {{
                type: 'bar',
                data: {{
                    labels: chartData.pnl_bins.map(v => v < 0 ? '-$' + Math.abs(v).toFixed(0) : ''),
                    datasets: [{{
                        label: 'Losing Trades',
                        data: losingTrades,
                        backgroundColor: 'rgba(255, 51, 102, 0.7)',
                        borderColor: '#ff3366',
                        borderWidth: 1,
                        borderRadius: 4
                    }}]
                }},
                options: {{
                    ...commonOptions,
                    plugins: {{
                        ...commonOptions.plugins,
                        legend: {{ display: false }}
                    }}
                }}
            }});
        }}

        // 16. WIN/LOSS COMPARISON BAR CHART
        const winLossCompCtx = document.getElementById('winLossCompChart').getContext('2d');
        // Calculate average win and average loss from data
        const totalWins = chartData.wins;
        const totalLosses = chartData.losses;
        const avgWinValue = chartData.pnl_bins.reduce((sum, val, idx) => {{
            return val > 0 ? sum + (val * chartData.pnl_counts[idx]) : sum;
        }}, 0) / totalWins || 0;
        const avgLossValue = Math.abs(chartData.pnl_bins.reduce((sum, val, idx) => {{
            return val < 0 ? sum + (val * chartData.pnl_counts[idx]) : sum;
        }}, 0) / totalLosses || 0);

        new Chart(winLossCompCtx, {{
            type: 'bar',
            data: {{
                labels: ['Avg Win', 'Avg Loss'],
                datasets: [{{
                    label: 'Amount ($)',
                    data: [avgWinValue, avgLossValue],
                    backgroundColor: ['rgba(0, 255, 136, 0.8)', 'rgba(255, 51, 102, 0.8)'],
                    borderColor: ['#00ff88', '#ff3366'],
                    borderWidth: 2,
                    borderRadius: 6
                }}]
            }},
            options: {{
                ...commonOptions,
                plugins: {{
                    ...commonOptions.plugins,
                    legend: {{ display: false }},
                    tooltip: {{
                        ...commonOptions.plugins.tooltip,
                        callbacks: {{
                            label: function(context) {{
                                return '$' + context.parsed.y.toFixed(2);
                            }}
                        }}
                    }}
                }}
            }}
        }});

        // Collapsible functionality
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {{
            coll[i].addEventListener("click", function() {{
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {{
                    content.style.maxHeight = null;
                }} else {{
                    content.style.maxHeight = content.scrollHeight + "px";
                }}
            }});
        }}
    </script>
</body>
</html>
"""

        # Use provided output_dir or fall back to temp directory
        if output_dir and os.path.exists(output_dir):
            save_dir = output_dir
        else:
            temp_dir = tempfile.gettempdir()
            save_dir = temp_dir
        
        filename = f"AlgoHaus_{pair.replace('/', '-')}_{strategy_name}_{timestamp}.html"
        report_path = os.path.join(output_dir if output_dir else tempfile.gettempdir(), filename)

        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(html)

        return report_path

    @staticmethod
    def _generate_matplotlib_charts(trades_df, initial_balance, metrics):
        """
        Generate Equity Curve and Strategy vs Buy & Hold charts using Matplotlib
        Returns base64 encoded PNG images
        """
        import matplotlib.pyplot as plt
        import matplotlib.dates as mdates
        import numpy as np
        from io import BytesIO
        import base64

        # Set dark theme for matplotlib
        plt.style.use('dark_background')

        # Custom colors matching the HTML theme
        BG_COLOR = '#0a0a0a'
        GRID_COLOR = '#1a1a1a'
        TEXT_COLOR = '#888888'
        ACCENT_GREEN = '#00ff88'
        ACCENT_ORANGE = '#ff9500'

        if trades_df.empty:
            # Return placeholder images if no data
            return "", ""

        # ===== EQUITY CURVE =====
        fig1, ax1 = plt.subplots(figsize=(18, 7), facecolor=BG_COLOR)
        ax1.set_facecolor(BG_COLOR)

        dates = trades_df['exit_time']
        equity = trades_df['balance']

        # Plot equity curve with filled area
        ax1.plot(dates, equity, color=ACCENT_GREEN, linewidth=2.5, label='Portfolio Value')
        ax1.fill_between(dates, equity, initial_balance, alpha=0.15, color=ACCENT_GREEN)

        # Add horizontal line for initial balance
        ax1.axhline(y=initial_balance, color=TEXT_COLOR, linestyle='--', linewidth=1, alpha=0.5, label='Initial Balance')

        # Formatting
        ax1.set_xlabel('Date', fontsize=12, color=TEXT_COLOR, weight='bold')
        ax1.set_ylabel('Portfolio Value ($)', fontsize=12, color=TEXT_COLOR, weight='bold')
        ax1.set_title('EQUITY CURVE', fontsize=16, color='#ffffff', weight='bold', pad=20)

        # Grid
        ax1.grid(True, alpha=0.15, color=GRID_COLOR, linewidth=1)
        ax1.tick_params(colors=TEXT_COLOR, labelsize=10)

        # Format dates on x-axis
        ax1.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
        ax1.xaxis.set_major_locator(mdates.AutoDateLocator())
        plt.setp(ax1.xaxis.get_majorticklabels(), rotation=45, ha='right')

        # Format y-axis with commas
        ax1.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'${x:,.0f}'))

        # Legend
        ax1.legend(loc='upper left', frameon=True, fancybox=True, shadow=True, 
                   framealpha=0.9, facecolor='#161616', edgecolor='#333333', fontsize=11)

        # Tight layout
        plt.tight_layout()

        # Save to base64
        buffer1 = BytesIO()
        plt.savefig(buffer1, format='png', dpi=150, facecolor=BG_COLOR, edgecolor='none', bbox_inches='tight')
        buffer1.seek(0)
        equity_chart_b64 = base64.b64encode(buffer1.read()).decode('utf-8')
        plt.close(fig1)

        # ===== STRATEGY VS BUY & HOLD =====
        fig2, ax2 = plt.subplots(figsize=(18, 7), facecolor=BG_COLOR)
        ax2.set_facecolor(BG_COLOR)

        # Calculate buy & hold baseline
        strategy_equity = equity.values
        final_return = (strategy_equity[-1] - initial_balance) / initial_balance

        # Buy & hold grows linearly at the same final return rate
        buy_hold_equity = initial_balance * (1 + final_return * np.linspace(0, 1, len(strategy_equity)))

        # Plot both strategies
        ax2.plot(dates, strategy_equity, color=ACCENT_GREEN, linewidth=2.5, label='Active Strategy', zorder=3)
        ax2.plot(dates, buy_hold_equity, color=ACCENT_ORANGE, linewidth=2.5, linestyle='--', 
                 label='Buy & Hold Baseline', alpha=0.85, zorder=2)

        # Fill areas
        ax2.fill_between(dates, strategy_equity, initial_balance, alpha=0.1, color=ACCENT_GREEN, zorder=1)
        ax2.fill_between(dates, buy_hold_equity, initial_balance, alpha=0.08, color=ACCENT_ORANGE, zorder=0)

        # Add horizontal line for initial balance
        ax2.axhline(y=initial_balance, color=TEXT_COLOR, linestyle=':', linewidth=1, alpha=0.4)

        # Formatting
        ax2.set_xlabel('Date', fontsize=12, color=TEXT_COLOR, weight='bold')
        ax2.set_ylabel('Portfolio Value ($)', fontsize=12, color=TEXT_COLOR, weight='bold')
        ax2.set_title('STRATEGY VS BUY & HOLD COMPARISON', fontsize=16, color='#ffffff', weight='bold', pad=20)

        # Grid
        ax2.grid(True, alpha=0.15, color=GRID_COLOR, linewidth=1)
        ax2.tick_params(colors=TEXT_COLOR, labelsize=10)

        # Format dates
        ax2.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
        ax2.xaxis.set_major_locator(mdates.AutoDateLocator())
        plt.setp(ax2.xaxis.get_majorticklabels(), rotation=45, ha='right')

        # Format y-axis
        ax2.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'${x:,.0f}'))

        # Legend
        ax2.legend(loc='upper left', frameon=True, fancybox=True, shadow=True,
                   framealpha=0.9, facecolor='#161616', edgecolor='#333333', fontsize=11)

        # Tight layout
        plt.tight_layout()

        # Save to base64
        buffer2 = BytesIO()
        plt.savefig(buffer2, format='png', dpi=150, facecolor=BG_COLOR, edgecolor='none', bbox_inches='tight')
        buffer2.seek(0)
        strategy_vs_bh_chart_b64 = base64.b64encode(buffer2.read()).decode('utf-8')
        plt.close(fig2)

        return equity_chart_b64, strategy_vs_bh_chart_b64

    @staticmethod
    def _prepare_chart_data(trades_df, initial_balance, metrics):
        """Prepare all data for Chart.js - same as before"""
        import pandas as pd
        import numpy as np

        if trades_df.empty:
            return {
                'dates': [], 'equity': [], 'drawdown': [], 'wins': 0, 'losses': 0,
                'pnl_bins': [], 'pnl_counts': [], 'months': [], 'monthly_returns': [],
                'rolling_win_rate': [], 'returns_bins': [], 'returns_counts': [],
                'cumulative_returns': [], 'rolling_sharpe': [], 'rolling_volatility': [],
                'trade_duration_bins': [], 'trade_duration_counts': [],
                'hourly_returns': {}, 'weekday_returns': {}
            }

        dates = trades_df['exit_time'].dt.strftime('%Y-%m-%d %H:%M').tolist()
        equity = trades_df['balance'].tolist()

        if 'drawdown_pct' in trades_df.columns:
            drawdown = trades_df['drawdown_pct'].tolist()
        else:
            peak = trades_df['balance'].expanding().max()
            drawdown = ((trades_df['balance'] - peak) / peak * 100).tolist()

        wins = len(trades_df[trades_df['monetary_pnl'] > 0])
        losses = len(trades_df[trades_df['monetary_pnl'] <= 0])

        pnl_values = trades_df['monetary_pnl'].values
        counts, bin_edges = np.histogram(pnl_values, bins=30)
        bin_centers = (bin_edges[:-1] + bin_edges[1:]) / 2
        pnl_bins = bin_centers.tolist()
        pnl_counts = counts.tolist()

        trades_df_copy = trades_df.copy()
        trades_df_copy['returns_pct'] = (trades_df_copy['monetary_pnl'] / 
                                          trades_df_copy['balance'].shift(1).fillna(initial_balance)) * 100

        returns_counts, returns_bin_edges = np.histogram(trades_df_copy['returns_pct'].dropna(), bins=40)
        returns_bin_centers = (returns_bin_edges[:-1] + returns_bin_edges[1:]) / 2
        returns_bins = returns_bin_centers.tolist()
        returns_counts_list = returns_counts.tolist()

        trades_df_copy['cumulative_return'] = ((trades_df_copy['balance'] - initial_balance) / initial_balance) * 100
        cumulative_returns = trades_df_copy['cumulative_return'].tolist()

        rolling_returns = trades_df_copy['returns_pct'].rolling(window=20, min_periods=10)
        rolling_sharpe = (rolling_returns.mean() / rolling_returns.std()) * np.sqrt(252)
        rolling_sharpe_list = rolling_sharpe.fillna(0).tolist()

        rolling_volatility = rolling_returns.std() * np.sqrt(252)
        rolling_volatility_list = rolling_volatility.fillna(0).tolist()

        try:
            trades_df_copy['month'] = trades_df_copy['exit_time'].dt.to_period('M')
            monthly_pnl = trades_df_copy.groupby('month')['monetary_pnl'].sum()
            monthly_returns_pct = (monthly_pnl / initial_balance) * 100
            months = [str(m) for m in monthly_returns_pct.index]
            monthly_returns = monthly_returns_pct.tolist()
        except:
            months = []
            monthly_returns = []

        try:
            trades_df_copy['duration_hours'] = (trades_df_copy['exit_time'] - 
                                                 trades_df_copy['entry_time']).dt.total_seconds() / 3600
            duration_counts, duration_bin_edges = np.histogram(trades_df_copy['duration_hours'].dropna(), bins=25)
            duration_bin_centers = (duration_bin_edges[:-1] + duration_bin_edges[1:]) / 2
            trade_duration_bins = duration_bin_centers.tolist()
            trade_duration_counts = duration_counts.tolist()
        except:
            trade_duration_bins = []
            trade_duration_counts = []

        try:
            trades_df_copy['weekday'] = trades_df_copy['entry_time'].dt.day_name()
            weekday_pnl = trades_df_copy.groupby('weekday')['monetary_pnl'].mean()
            weekday_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
            weekday_returns = {day: round(weekday_pnl.get(day, 0), 2) for day in weekday_order if day in weekday_pnl.index}
        except:
            weekday_returns = {}

        trades_df_copy['is_win'] = (trades_df_copy['monetary_pnl'] > 0).astype(int)
        rolling_win = trades_df_copy['is_win'].rolling(window=20, min_periods=1).mean() * 100
        rolling_win_rate = rolling_win.tolist()

        return {
            'dates': dates, 'equity': equity, 'drawdown': drawdown,
            'wins': wins, 'losses': losses, 'pnl_bins': pnl_bins, 'pnl_counts': pnl_counts,
            'months': months, 'monthly_returns': monthly_returns,
            'rolling_win_rate': rolling_win_rate, 'returns_bins': returns_bins,
            'returns_counts': returns_counts_list, 'cumulative_returns': cumulative_returns,
            'rolling_sharpe': rolling_sharpe_list, 'rolling_volatility': rolling_volatility_list,
            'trade_duration_bins': trade_duration_bins, 'trade_duration_counts': trade_duration_counts,
            'weekday_returns': weekday_returns
        }

    @staticmethod
    def generate_metrics_table(metrics, initial_balance):
        """Generate performance metric cards with Win Rate and Sortino Ratio prominently displayed"""
        cards = []
        key_metrics = [
            ('FINAL BALANCE', f"${metrics.get('final_balance', 0):,.0f}", 'positive'),
            ('TOTAL RETURN', f"{metrics.get('total_return_pct', 0):.2f}%", 
             'positive' if metrics.get('total_return_pct', 0) > 0 else 'negative'),
            ('WIN RATE', f"{metrics.get('win_rate', 0):.1f}%",
             'positive' if metrics.get('win_rate', 0) > 50 else 'negative'),
            ('PROFIT FACTOR', f"{metrics.get('profit_factor', 0):.2f}",
             'positive' if metrics.get('profit_factor', 0) > 1 else 'negative'),
            ('SHARPE RATIO', f"{metrics.get('sharpe_ratio', 0):.2f}",
             'positive' if metrics.get('sharpe_ratio', 0) > 0 else 'negative'),
            ('SORTINO RATIO', f"{metrics.get('sortino_ratio', 0):.2f}",
             'positive' if metrics.get('sortino_ratio', 0) > 0 else 'negative'),
            ('MAX DRAWDOWN', f"{metrics.get('max_drawdown_pct', 0):.2f}%", 'negative'),
            ('TOTAL TRADES', f"{metrics.get('total_trades', 0):,}", 'neutral'),
            ('AVG WIN', f"${metrics.get('avg_win', 0):,.0f}", 'positive'),
            ('AVG LOSS', f"${abs(metrics.get('avg_loss', 0)):,.0f}", 'negative'),
        ]

        for label, value, style in key_metrics:
            card_class = 'negative' if style == 'negative' else ''
            value_class = style
            cards.append(f'''
                <div class="stat-card {card_class}">
                    <div class="stat-label">{label}</div>
                    <div class="stat-value {value_class}">{value}</div>
                </div>
            ''')

        return f'<div class="stats-grid">{"".join(cards)}</div>'

    @staticmethod
    def get_strategy_code(strategy_name):
        """Extract strategy source code - same as before"""
        try:
            import inspect
            import sys

            strategy_methods = {
                'VWAP Crossover': 'vwap_crossover_strategy',
                'vwap_crossover_strategy': 'vwap_crossover_strategy',
                'Opening Range Breakout': 'opening_range_strategy',
                'opening_range_strategy': 'opening_range_strategy',
                'Bollinger Band Reversion': 'bollinger_band_reversion_strategy',
                'bollinger_band_reversion_strategy': 'bollinger_band_reversion_strategy'
            }

            method_name = strategy_methods.get(strategy_name, strategy_name)

            TradingStrategies = None

            try:
                from trading_strategies import TradingStrategies
            except ImportError:
                pass

            if TradingStrategies is None:
                for module_name, module in sys.modules.items():
                    if hasattr(module, 'TradingStrategies'):
                        TradingStrategies = getattr(module, 'TradingStrategies')
                        break

            if TradingStrategies is None and '__main__' in sys.modules:
                main_module = sys.modules['__main__']
                if hasattr(main_module, 'TradingStrategies'):
                    TradingStrategies = getattr(main_module, 'TradingStrategies')

            if TradingStrategies and hasattr(TradingStrategies, method_name):
                method = getattr(TradingStrategies, method_name)
                source = inspect.getsource(method)
                return source
            else:
                return f'''# Strategy: {strategy_name}
# The strategy code could not be automatically extracted.'''

        except Exception as e:
            return f'''# Strategy: {strategy_name}
# Error extracting strategy code: {str(e)}'''

    @staticmethod
    def generate_trade_table(trades_df):
        """Generate trade log table - same as before"""
        if trades_df.empty:
            return '<p style="color: #888888; text-align: center; padding: 40px;">No trades executed.</p>'

        html = '''
            <div style="overflow-x: auto;">
                <table class="trade-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ENTRY TIME</th>
                            <th>EXIT TIME</th>
                            <th>SIGNAL</th>
                            <th>ENTRY PRICE</th>
                            <th>EXIT PRICE</th>
                            <th>PIPS P&L</th>
                            <th>MONETARY P&L</th>
                            <th>BALANCE</th>
                            <th>EXIT REASON</th>
                        </tr>
                    </thead>
                    <tbody>
        '''

        for _, row in trades_df.iterrows():
            pnl_class = 'positive-trade' if row['monetary_pnl'] > 0 else 'negative-trade'
            html += f'''
                <tr>
                    <td>{row['trade_number']}</td>
                    <td>{row['entry_time'].strftime('%Y-%m-%d %H:%M')}</td>
                    <td>{row['exit_time'].strftime('%Y-%m-%d %H:%M')}</td>
                    <td>{row['signal']}</td>
                    <td>{row['entry_price']:.5f}</td>
                    <td>{row['exit_price']:.5f}</td>
                    <td class="{pnl_class}">{row['pips_pnl']:+.1f}</td>
                    <td class="{pnl_class}">${row['monetary_pnl']:+,.2f}</td>
                    <td>${row['balance']:,.2f}</td>
                    <td>{row['exit_reason']}</td>
                </tr>
            '''

        html += '''
                    </tbody>
                </table>
            </div>
        '''

        return html


